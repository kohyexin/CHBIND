<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绑定渠道</title>
    <link rel="stylesheet" href="channel-binding-config.css">
    <link rel="stylesheet" href="foundry-chat.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-search">
            <span class="search-icon">🔍</span>
            <input type="text" placeholder="搜索" class="search-input">
        </div>
        <nav class="sidebar-nav">
            <ul class="nav-menu">
                <li class="nav-item active">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">🏠</span>
                        <span class="nav-text">首页</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">🕐</span>
                        <span class="nav-text">交易查询</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">🤝</span>
                        <span class="nav-text">纠纷管理</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">🔔</span>
                        <span class="nav-text">拒付预警</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">🛡️</span>
                        <span class="nav-text">风险控制</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">💰</span>
                        <span class="nav-text">资金管理</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">📊</span>
                        <span class="nav-text">报表分析</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
                <li class="nav-item has-submenu active">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">👥</span>
                        <span class="nav-text">商户</span>
                        <span class="nav-arrow">▼</span>
                    </a>
                    <ul class="submenu">
                        <li class="submenu-item">
                            <a href="#" class="submenu-link">商户维护</a>
                        </li>
                        <li class="submenu-item">
                            <a href="#" class="submenu-link">商户收单配置</a>
                        </li>
                        <li class="submenu-item">
                            <a href="channel-binding-config.html" class="submenu-link">绑定渠道</a>
                        </li>
                        <li class="submenu-item active">
                            <a href="channel-binding-admin.html" class="submenu-link">绑定渠道配置</a>
                        </li>
                        <li class="submenu-item">
                            <a href="#" class="submenu-link">交易网站审核</a>
                        </li>
                        <li class="submenu-item">
                            <a href="#" class="submenu-link">商户LOGO维护</a>
                        </li>
                        <li class="submenu-item has-nested-submenu">
                            <a href="#" class="submenu-link">
                                <span class="nested-arrow">▶</span>
                                商户结算设定
                            </a>
                            <ul class="nested-submenu">
                                <li class="nested-submenu-item">
                                    <a href="channel-binding-admin.html" class="nested-submenu-link">渠道轮循</a>
                                </li>
                                <li class="nested-submenu-item">
                                    <a href="#" class="nested-submenu-link">产品主档</a>
                                </li>
                                <li class="nested-submenu-item">
                                    <a href="#" class="nested-submenu-link">商户绑定APP</a>
                                </li>
                            </ul>
                        </li>
                        <li class="submenu-item has-nested-submenu">
                            <a href="#" class="submenu-link">
                                <span class="nested-arrow">▶</span>
                                商户站点配置
                            </a>
                            <ul class="nested-submenu">
                                <li class="nested-submenu-item">
                                    <a href="#" class="nested-submenu-link">地址主档</a>
                                </li>
                                <li class="nested-submenu-item">
                                    <a href="channel-binding-config.html" class="nested-submenu-link">绑定渠道</a>
                                </li>
                                <li class="nested-submenu-item">
                                    <a href="#" class="nested-submenu-link">商户币种转换</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">📄</span>
                        <span class="nav-text">收单行管理</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <span class="nav-icon">⚙️</span>
                        <span class="nav-text">系统管理</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <a href="#" class="footer-link">渠道操作手册</a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-wrapper">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <span class="breadcrumb-text">商户 > 绑定渠道</span>
            </div>
            <div class="header-center">
                <div class="logo">STAR SAAS DEMO</div>
            </div>
            <div class="header-right">
                <span class="timezone">(UTC+00:00)</span>
                <button class="header-icon-btn">⚙️</button>
                <button class="header-icon-btn">👤</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
        <!-- Page Title -->
        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-button active" data-tab="channel-binding" onclick="switchTab('channel-binding')">
                    渠道绑定
                </button>
                <button class="tab-button" data-tab="platform-config" onclick="switchTab('platform-config')">
                    平台配置
                </button>
                <button class="tab-button" data-tab="round-robin" onclick="switchTab('round-robin')">
                    轮循配置
                </button>
                <button class="tab-button" data-tab="analysis" onclick="switchTab('analysis')">
                    分析
                </button>
                <button class="tab-button" data-tab="charts" onclick="switchTab('charts')" style="display: none;">
                    图表
                </button>
            </div>
        </div>

        <!-- Tab 1: Channel Binding -->
        <div class="tab-content active" id="channel-binding-tab">
        
        <!-- Summary Section: List of Configured Channels -->
        <div class="summary-section" id="summarySection">
            <!-- Filter Controls -->
            <div class="filter-container">
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="filter-merchant-name">商户名:</label>
                        <input type="text" id="filter-merchant-name" class="filter-input" placeholder="请输入商户名">
                    </div>
                    <div class="filter-group">
                        <label for="filter-sub-account">子账号:</label>
                        <select id="filter-sub-account" class="filter-select">
                            <option value="">请选择</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-channel">渠道:</label>
                        <select id="filter-channel" class="filter-select">
                            <option value="">请选择</option>
                        </select>
                    </div>
                    <button class="filter-search-btn" onclick="applyFilters()">搜索</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-container">
                <button class="action-btn bind-btn" onclick="showAddNewForm()">
                    <span class="action-icon">🔗</span>
                    <span>绑定</span>
                </button>
                <button class="action-btn modify-btn" onclick="modifySelected()" disabled>
                    <span class="action-icon">✏️</span>
                    <span>修改</span>
                </button>
                <button class="action-btn unbind-btn" onclick="unbindSelected()" disabled>
                    <span class="action-icon">🔓</span>
                    <span>解绑</span>
                </button>
                <button class="action-btn copy-btn" onclick="copySelected()" disabled>
                    <span class="action-icon">📋</span>
                    <span>复制</span>
                </button>
            </div>

            <!-- Summary Table -->
            <div class="table-container">
                <table class="summary-table" id="summaryTable">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="radio" name="table-select" style="display: none;">
                            </th>
                            <th>商户名 <span class="sort-icon">▼</span></th>
                            <th>子账号 <span class="sort-icon">▼</span></th>
                            <th>渠道 <span class="sort-icon">▼</span></th>
                            <th>支付种类 <span class="sort-icon">▼</span></th>
                            <th>通道名 <span class="sort-icon">▼</span></th>
                            <th>渠道终端代码 <span class="sort-icon">▼</span></th>
                            <th>渠道终端密码 <span class="sort-icon">▼</span></th>
                            <th>渠道终端token <span class="sort-icon">▼</span></th>
                            <th>PayPal商户账号 <span class="sort-icon">▼</span></th>
                            <th>状态 <span class="sort-icon">▼</span></th>
                            <th>创建人 <span class="sort-icon">▼</span></th>
                            <th>创建时间 <span class="sort-icon">▼</span></th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info">
                    <span id="paginationRange">1~10</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevPageBtn" onclick="changePage(-1)" disabled>上一页</button>
                    <button class="pagination-btn" id="nextPageBtn" onclick="changePage(1)">下一页</button>
                    <select class="pagination-select" id="pageSizeSelect" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Configuration Form Card (Hidden by default) -->
        <div class="config-card" id="configFormCard" style="display: none;">
            <div class="card-body">
                <!-- Unified Configuration Form -->
                <form id="channelBindingForm" class="config-form">
                    <!-- Step 1: Basic Channel Information -->
                    <div class="form-section" data-section="1">
                        <!-- Compact Hint Display -->
                        <div class="hint-display-compact" id="channelHintDisplay" style="display: none; margin-bottom: 20px;">
                            <div class="hint-header">
                                <div class="hint-title">
                                    <span class="hint-icon">💡</span>
                                    <span>配置提示</span>
                                </div>
                                <button class="hint-toggle-btn" onclick="toggleHintExpansion()">
                                    <span id="hintToggleText">展开查看</span>
                                    <span class="hint-arrow">▼</span>
                                </button>
                            </div>
                            <div class="hint-content-collapsed" id="hintContentCollapsed">
                                <div class="hint-preview-thumbnail" id="hintThumbnail"></div>
                                <div class="hint-text-preview" id="hintTextPreview"></div>
                            </div>
                            <div class="hint-content-expanded" id="hintContentExpanded" style="display: none;">
                                <div class="hint-image-container" id="hintImageContainer"></div>
                                <div class="hint-text-full" id="hintTextFull"></div>
                            </div>
                        </div>
                        
                        <!-- Default Info Box (shown when no channel selected) -->
                        <div class="info-box" id="channelInfoBox">
                            <p><strong>提示：</strong>请选择渠道类型以继续配置</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="payment-type">支付种类 <span class="required">*</span></label>
                                <select id="payment-type" name="paymentType" required class="form-select">
                                    <option value="">请选择支付种类</option>
                                    <option value="credit_card">信用卡</option>
                                    <option value="mix">混合支付</option>
                                </select>
                                <small class="form-hint">选择支付种类</small>
                            </div>
                            <div class="form-group">
                                <label for="channel">渠道 <span class="required">*</span></label>
                                <select id="channel" name="channel" required class="form-select">
                                    <option value="">请选择渠道</option>
                                    <option value="ysepay">YSEPAY</option>
                                    <option value="rumble">RUMBLE</option>
                                    <option value="evonet">EVONET</option>
                                    <option value="paysaas">PAYSAAS</option>
                                </select>
                                <small class="form-hint">选择需要绑定的渠道</small>
                            </div>
                            <div class="form-group">
                                <label for="merchant-name">商户名 <span class="required">*</span></label>
                                <select id="merchant-name" name="merchantName" required class="form-select">
                                    <option value="">请选择商户名</option>
                                    <!-- Options will be loaded from backend -->
                                </select>
                                <small class="form-hint">选择需要配置的商户名</small>
                            </div>
                            <div class="form-group">
                                <label for="sub-account">子账号 <span class="required">*</span></label>
                                <select id="sub-account" name="subAccount" required class="form-select">
                                    <option value="">请选择子账号</option>
                                    <!-- Options will be loaded from backend based on merchant selection -->
                                </select>
                                <small class="form-hint">选择需要配置的子账号</small>
                            </div>

                            <!-- Domain Name Binding (for Iframe channels) -->
                            <div class="form-group" id="domainBindingSection" style="display: none;">
                                <label for="domain-name">商户域名绑定名称 <span class="required">*</span></label>
                                <select id="domain-name" name="domainName" class="form-select">
                                    <option value="">请选择域名</option>
                                    <option value="iframe-payment-page-new">IFrame Payment page New</option>
                                    <!-- More options can be loaded from backend -->
                                </select>
                                <small class="form-hint">选择已配置的商户域名</small>
                            </div>

                            <div class="form-group">
                                <label for="account-name">账号名 <span class="required">*</span></label>
                                <input type="text" id="account-name" name="accountName" required 
                                       placeholder="请输入自定义账号名" class="form-input">
                                <small class="form-hint">注意：最好不要使用 default，使用唯一的名称，配置轮循时才知道交易走的是哪个账号</small>
                            </div>
                            
                            <!-- YSEPAY Specific Fields -->
                            <div class="form-group ysepay-only" style="display: none;">
                                <label for="merchant-id">商户号 <span class="required">*</span></label>
                                <input type="text" id="merchant-id" name="merchantId" 
                                       placeholder="从YSEPAY方获取的商户号" class="form-input">
                                <small class="form-hint">从YSEPAY方获取的商户号</small>
                            </div>
                            <div class="form-group ysepay-only" style="display: none;">
                                <label for="sub-merchant">子商户 <span class="required">*</span></label>
                                <input type="text" id="sub-merchant" name="subMerchant" 
                                       placeholder="从YSEPAY方获取的子商户" class="form-input">
                                <small class="form-hint">从YSEPAY方获取的子商户</small>
                            </div>
                            <div class="form-group ysepay-only" style="display: none;">
                                <label for="key-aeskey">Key__AesKey <span class="required">*</span></label>
                                <div class="key-input-group">
                                    <input type="password" id="key" name="key" 
                                           placeholder="Key" class="form-input key-input">
                                    <span class="key-separator">__</span>
                                    <input type="password" id="aeskey" name="aesKey" 
                                           placeholder="AesKey" class="form-input key-input">
                                    <button type="button" class="toggle-password" data-target="key">👁️</button>
                                    <button type="button" class="toggle-password" data-target="aeskey">👁️</button>
                                </div>
                                <small class="form-hint">填写 YSEPAY 方获取的 Key 与 AesKey，中间用"__"拼接</small>
                            </div>
                            
                            <!-- RUMBLE Specific Fields -->
                            <div class="form-group full-width rumble-only" style="display: none;">
                                <label for="auth-token">authToken <span class="required">*</span></label>
                                <input type="password" id="auth-token" name="authToken" 
                                       placeholder="从 RUMBLE 方获取的 authToken" class="form-input">
                                <button type="button" class="toggle-password" data-target="auth-token">👁️</button>
                                <small class="form-hint">填写从 RUMBLE 方获取的 authToken</small>
                            </div>
                            
                            <!-- EVONET Specific Fields -->
                            <div class="form-group evonet-only" style="display: none;">
                                <label for="evonet-store-id">Store ID <span class="required">*</span></label>
                                <input type="text" id="evonet-store-id" name="evonetStoreId" 
                                       placeholder="从EVONET方获取的Store ID" class="form-input">
                                <small class="form-hint">填写EVONET方获取的Store ID</small>
                            </div>
                            <div class="form-group evonet-only" style="display: none;">
                                <label for="evonet-signkey">SignKey <span class="required">*</span></label>
                                <input type="password" id="evonet-signkey" name="evonetSignKey" 
                                       placeholder="从EVONET方获取的SignKey" class="form-input">
                                <button type="button" class="toggle-password" data-target="evonet-signkey">👁️</button>
                                <small class="form-hint">填写EVONET方获取的SignKey</small>
                            </div>
                            <div class="form-group full-width evonet-only" style="display: none;">
                                <label for="evonet-rsa-public-key">RSA Public Key <span class="required">*</span></label>
                                <textarea id="evonet-rsa-public-key" name="evonetRsaPublicKey" 
                                          placeholder="从EVONET方获取的RSA Public Key" 
                                          class="form-textarea" rows="4"></textarea>
                                <small class="form-hint">填写EVONET方获取的RSA Public Key</small>
                            </div>
                            
                            <!-- PAYSAAS Specific Fields -->
                            <div class="form-group paysaas-only" style="display: none;">
                                <label for="paysaas-merchant-id">商户号 <span class="required">*</span></label>
                                <input type="text" id="paysaas-merchant-id" name="paysaasMerchantId" 
                                       placeholder="从PAYSAAS方获取的商户号" class="form-input">
                                <small class="form-hint">从PAYSAAS方获取的商户号</small>
                            </div>
                            <div class="form-group paysaas-only" style="display: none;">
                                <label for="paysaas-sub-merchant">子商户 <span class="required">*</span></label>
                                <input type="text" id="paysaas-sub-merchant" name="paysaasSubMerchant" 
                                       placeholder="从PAYSAAS方获取的子商户" class="form-input">
                                <small class="form-hint">从PAYSAAS方获取的子商户</small>
                            </div>
                            <div class="form-group paysaas-only" style="display: none;">
                                <label for="paysaas-key-aeskey">Key__AesKey <span class="required">*</span></label>
                                <div class="key-input-group">
                                    <input type="password" id="paysaas-key" name="paysaasKey" 
                                           placeholder="Key" class="form-input key-input">
                                    <span class="key-separator">__</span>
                                    <input type="password" id="paysaas-aeskey" name="paysaasAesKey" 
                                           placeholder="AesKey" class="form-input key-input">
                                    <button type="button" class="toggle-password" data-target="paysaas-key">👁️</button>
                                    <button type="button" class="toggle-password" data-target="paysaas-aeskey">👁️</button>
                                </div>
                                <small class="form-hint">填写 PAYSAAS 方获取的 Key 与 AesKey，中间用"__"拼接</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="channel-name">通道命名</label>
                                <input type="text" id="channel-name" name="channelName" 
                                       placeholder="系统自动生成" class="form-input" readonly>
                                <small class="form-hint">系统自动生成</small>
                            </div>
                            
                            <!-- Card Type Information List -->
                            <div class="form-group full-width" id="cardTypeSection" style="display: none;">
                                <label>卡种信息列表 <span class="required">*</span></label>
                                <div class="card-type-list-container">
                                    <div class="card-type-list" id="cardTypeList">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Currency List Information -->
                            <div class="form-group full-width" id="currencySection" style="display: none;">
                                <label>币种列表信息 <span class="required">*</span></label>
                                <div class="currency-list-container">
                                    <div class="currency-list" id="currencyList">
                                        <!-- Will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Payment Method Binding -->
                    <div class="form-section" data-section="2" style="display: none;">
                        <h3 class="section-title">绑定支付方式</h3>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>支付方式 <span class="required">*</span></label>
                                <div class="checkbox-group" id="payment-methods-group">
                                    <!-- Options will be populated based on channel selection -->
                                </div>
                                <small class="form-hint" id="payment-methods-hint"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Currency Binding -->
                    <div class="form-section" data-section="3" style="display: none;">
                        <h3 class="section-title">绑定支付币种</h3>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>支付币种 <span class="required">*</span></label>
                                <div class="checkbox-group" id="currency-group">
                                    <!-- Options will be populated based on channel selection -->
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="currency-default" name="currencyDefault">
                                    <span>是否默认 (若配置币种转换需要勾选是否默认)</span>
                                </label>
                                <small class="form-hint" id="currency-default-hint" style="margin-top: 4px; display: block;"></small>
                            </div>
                            <div class="form-group full-width">
                                <label>支持交易国家 (可选)</label>
                                <select id="supported-countries" name="supportedCountries" 
                                        class="form-select" multiple>
                                    <option value="">不限制</option>
                                    <!-- Options will be loaded from backend -->
                                </select>
                                <small class="form-hint">一般情况下不需要选，除非想限制只在某些国家交易</small>
                            </div>
                            <div class="form-group full-width">
                                <label>平台 (可选)</label>
                                <select id="platform" name="platform" class="form-select" multiple>
                                    <option value="">不限制</option>
                                    <!-- Options will be loaded from backend -->
                                </select>
                                <small class="form-hint">一般情况下不需要选，除非想限制只在某些平台交易</small>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">上一步</button>
                    <button type="button" class="btn btn-secondary" id="backBtn" onclick="hideAddNewForm()">返回</button>
                    <button type="button" class="btn btn-secondary" id="resetBtn">重置</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">提交</button>
                    <button type="button" class="btn btn-primary" id="submitBtn" style="display: none;">提交配置</button>
                </div>

            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="message-container" style="display: none;"></div>
        </div>
        <!-- End Tab 1: Channel Binding -->

        <!-- Tab 2: Platform Configuration -->
        <div class="tab-content" id="platform-config-tab" style="display: none;">
            <div class="config-card">
                <div class="card-body">
                    <form id="platform-config-form" class="config-form">
                        <div class="form-grid" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label>商户名 <span class="required">*</span></label>
                                <select id="platform-merchant-name" name="platformMerchantName" required class="form-select">
                                    <option value="">请选择商户名</option>
                                    <!-- Options will be loaded from backend -->
                                </select>
                                <small class="form-hint">选择需要配置的商户名</small>
                            </div>
                            <div class="form-group">
                                <label>子账号 <span class="required">*</span></label>
                                <select id="platform-sub-account" name="platformSubAccount" required class="form-select" disabled>
                                    <option value="">请选择子账号</option>
                                    <!-- Options will be loaded from backend based on merchant selection -->
                                </select>
                                <small class="form-hint">选择需要配置的子账号</small>
                            </div>
                            <div class="form-group">
                                <label>平台 <span class="required">*</span></label>
                                <select id="platform-select" name="platform" class="form-select" required>
                                    <option value="">请选择平台</option>
                                    <option value="shopyy">ShopYY</option>
                                    <option value="shopline">Shopline</option>
                                    <option value="shoplazza">Shoplazza</option>
                                </select>
                                <small class="form-hint">选择您使用的电商平台</small>
                            </div>
                            <div class="form-group">
                                <label>接口类型 <span class="required">*</span></label>
                                <select id="interface-type-select" name="interfaceType" class="form-select" required>
                                    <option value="">请选择接口类型</option>
                                    <option value="direct">直连 (Direct)</option>
                                    <option value="redirect">跳转 (Redirect)</option>
                                </select>
                                <small class="form-hint">选择平台使用的接口类型</small>
                            </div>
                        </div>

                        <!-- Platform Configuration Hint Display -->
                        <div id="platform-hint-section" style="display: none; margin-top: 24px;">
                            <!-- Compact Hint Display -->
                            <div class="hint-display-compact" id="platformHintDisplay">
                                <div class="hint-header">
                                    <div class="hint-title">
                                        <span class="hint-icon">💡</span>
                                        <span>配置提示</span>
                                    </div>
                                    <button class="hint-toggle-btn" onclick="togglePlatformHintExpansion()">
                                        <span id="platformHintToggleText">展开查看</span>
                                        <span class="hint-arrow">▼</span>
                                    </button>
                                </div>
                                <div class="hint-content-collapsed" id="platformHintContentCollapsed">
                                    <div class="hint-preview-thumbnail" id="platformHintThumbnail"></div>
                                    <div class="hint-text-preview" id="platformHintTextPreview"></div>
                                </div>
                                <div class="hint-content-expanded" id="platformHintContentExpanded" style="display: none;">
                                    <div class="hint-image-container" id="platformHintImageContainer"></div>
                                    <div class="hint-text-full" id="platformHintTextFull"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Platform Configuration Form Fields -->
                        <div id="platform-config-fields-section" style="display: none; margin-top: 24px;">
                            <!-- ShopYY Direct Configuration -->
                            <div id="shopyy-direct-fields" class="platform-config-fields" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>绑定接口类型 <span class="required">*</span></label>
                                        <select id="shopyy-direct-bind-interface-type" name="bindInterfaceType" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="2方" selected>2方</option>
                                            <option value="3方">3方</option>
                                        </select>
                                        <small class="form-hint">绑定接口类型，直连选择"2方"</small>
                                    </div>
                                    <div class="form-group">
                                        <label>平台来源 <span class="required">*</span></label>
                                        <select id="shopyy-direct-platform-source" name="platformSource" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="Shopyy" selected>Shopyy</option>
                                            <option value="Shopline">Shopline</option>
                                            <option value="Shoplazza">Shoplazza</option>
                                        </select>
                                        <small class="form-hint">平台来源，选择对应的平台</small>
                                    </div>
                                </div>
                            </div>

                            <!-- ShopYY Redirect Configuration -->
                            <div id="shopyy-redirect-fields" class="platform-config-fields" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>绑定接口类型 <span class="required">*</span></label>
                                        <select id="shopyy-redirect-bind-interface-type" name="bindInterfaceType" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="2方">2方</option>
                                            <option value="3方" selected>3方</option>
                                        </select>
                                        <small class="form-hint">绑定接口类型，跳转选择"3方"</small>
                                    </div>
                                    <div class="form-group">
                                        <label>平台来源 <span class="required">*</span></label>
                                        <select id="shopyy-redirect-platform-source" name="platformSource" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="Shopyy" selected>Shopyy</option>
                                            <option value="Shopline">Shopline</option>
                                            <option value="Shoplazza">Shoplazza</option>
                                        </select>
                                        <small class="form-hint">平台来源，选择对应的平台</small>
                                    </div>
                                    <div class="form-group">
                                        <label>商户域名绑定</label>
                                        <select id="shopyy-redirect-merchant-domain" name="merchantDomain" class="form-select">
                                            <option value="">请选择</option>
                                            <option value="checkout3">checkout3</option>
                                            <option value="IFrame Payment page New">IFrame Payment page New</option>
                                        </select>
                                        <small class="form-hint">商户域名绑定：跳转模式的商户域名配置为 "checkout3"，内嵌模式的商户域名配置为 "IFrame Payment page New"</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Shopline Direct Configuration -->
                            <div id="shopline-direct-fields" class="platform-config-fields" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>绑定接口类型 <span class="required">*</span></label>
                                        <select id="shopline-direct-bind-interface-type" name="bindInterfaceType" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="2方" selected>2方</option>
                                            <option value="3方">3方</option>
                                        </select>
                                        <small class="form-hint">绑定接口类型，直连选择"2方"</small>
                                    </div>
                                    <div class="form-group">
                                        <label>平台来源 <span class="required">*</span></label>
                                        <select id="shopline-direct-platform-source" name="platformSource" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="Shopyy">Shopyy</option>
                                            <option value="Shopline" selected>Shopline</option>
                                            <option value="Shoplazza">Shoplazza</option>
                                        </select>
                                        <small class="form-hint">平台来源，选择对应的平台</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Shopline Redirect Configuration -->
                            <div id="shopline-redirect-fields" class="platform-config-fields" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>绑定接口类型 <span class="required">*</span></label>
                                        <select id="shopline-redirect-bind-interface-type" name="bindInterfaceType" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="2方">2方</option>
                                            <option value="3方" selected>3方</option>
                                        </select>
                                        <small class="form-hint">绑定接口类型，跳转选择"3方"</small>
                                    </div>
                                    <div class="form-group">
                                        <label>平台来源 <span class="required">*</span></label>
                                        <select id="shopline-redirect-platform-source" name="platformSource" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="Shopyy">Shopyy</option>
                                            <option value="Shopline" selected>Shopline</option>
                                            <option value="Shoplazza">Shoplazza</option>
                                        </select>
                                        <small class="form-hint">平台来源，选择对应的平台</small>
                                    </div>
                                    <div class="form-group">
                                        <label>商户域名绑定</label>
                                        <select id="shopline-redirect-merchant-domain" name="merchantDomain" class="form-select">
                                            <option value="">请选择</option>
                                            <option value="checkout3">checkout3</option>
                                            <option value="IFrame Payment page New">IFrame Payment page New</option>
                                        </select>
                                        <small class="form-hint">商户域名绑定：跳转模式的商户域名配置为 "checkout3"，内嵌模式的商户域名配置为 "IFrame Payment page New"</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Shoplazza Direct Configuration -->
                            <div id="shoplazza-direct-fields" class="platform-config-fields" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>绑定接口类型 <span class="required">*</span></label>
                                        <select id="shoplazza-direct-bind-interface-type" name="bindInterfaceType" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="2方直连">2方直连</option>
                                            <option value="3方" selected>3方</option>
                                        </select>
                                        <small class="form-hint">绑定接口类型，平台配置选择"3方"</small>
                                    </div>
                                    <div class="form-group">
                                        <label>平台来源 <span class="required">*</span></label>
                                        <select id="shoplazza-direct-platform-source" name="platformSource" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="Shopyy">Shopyy</option>
                                            <option value="Shopline">Shopline</option>
                                            <option value="Shoplazza" selected>Shoplazza</option>
                                        </select>
                                        <small class="form-hint">平台来源，选择对应的平台</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Shoplazza Redirect Configuration -->
                            <div id="shoplazza-redirect-fields" class="platform-config-fields" style="display: none;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>绑定接口类型 <span class="required">*</span></label>
                                        <select id="shoplazza-redirect-bind-interface-type" name="bindInterfaceType" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="2方">2方</option>
                                            <option value="3方" selected>3方</option>
                                        </select>
                                        <small class="form-hint">绑定接口类型，跳转选择"3方"</small>
                                    </div>
                                    <div class="form-group">
                                        <label>平台来源 <span class="required">*</span></label>
                                        <select id="shoplazza-redirect-platform-source" name="platformSource" class="form-select" required disabled readonly>
                                            <option value="">请选择</option>
                                            <option value="Shopyy">Shopyy</option>
                                            <option value="Shopline">Shopline</option>
                                            <option value="Shoplazza" selected>Shoplazza</option>
                                        </select>
                                        <small class="form-hint">平台来源，选择对应的平台</small>
                                    </div>
                                    <div class="form-group">
                                        <label>商户域名绑定</label>
                                        <select id="shoplazza-redirect-merchant-domain" name="merchantDomain" class="form-select">
                                            <option value="">请选择</option>
                                            <option value="checkout3">checkout3</option>
                                            <option value="IFrame Payment page New">IFrame Payment page New</option>
                                        </select>
                                        <small class="form-hint">商户域名绑定：跳转模式的商户域名配置为 "checkout3"，内嵌模式的商户域名配置为 "IFrame Payment page New"</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="resetPlatformForm()">重置</button>
                                <button type="button" class="btn btn-primary" onclick="submitPlatformConfig()">提交配置</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- End Tab 2: Platform Configuration -->

        <!-- Tab 3: Round Robin Configuration -->
        <div class="tab-content" id="round-robin-tab" style="display: none;">
            <!-- Action Bar -->
            <div class="action-bar" style="margin-bottom: 20px;">
                <button type="button" class="btn btn-primary" onclick="addRoundRobinPlan()">新增</button>
                <button type="button" class="btn btn-primary" onclick="editRoundRobinPlan()" id="editRoundRobinBtn" disabled>修改</button>
            </div>

            <!-- Round Robin List Table -->
            <div class="config-card" id="roundrobin-list-card">
                <div class="card-header">
                    <h2>渠道轮询</h2>
                </div>
                <div class="card-body">
                    <table class="data-table" id="roundrobin-list-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-roundrobin"></th>
                                <th>商户号</th>
                                <th>子账号</th>
                                <th>轮询类型</th>
                                <th>支付方式</th>
                                <th>渠道名</th>
                                <th>每天交易笔数(Max)</th>
                                <th>每天交易金额(Max)</th>
                                <th>域名</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="roundrobin-list-tbody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px; color: #999;">
                                    暂无轮循配置，请点击【新增】按钮添加
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Round Robin Modal -->
            <div id="roundrobin-modal" class="modal" style="display: none;">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h2 id="roundrobin-modal-title">新增商户收单其他</h2>
                        <button class="modal-close" onclick="closeRoundRobinModal()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                        <form id="roundrobin-form">
                            <!-- Basic Configuration -->
                            <div class="form-section">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>商户号 <span class="required">*</span></label>
                                        <select id="rr-merchant" name="rrMerchant" class="form-select" required>
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>子账号 <span class="required">*</span></label>
                                        <select id="rr-subaccount" name="rrSubAccount" class="form-select" required disabled>
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>轮询类型 <span class="required">*</span></label>
                                        <select id="rr-type" name="rrType" class="form-select" required>
                                            <option value="">请选择</option>
                                            <option value="by-channel">分渠道名</option>
                                            <option value="by-subaccount">分子账号</option>
                                        </select>
                                        <small class="form-hint">若选择"分渠道名"，设置的每日交易笔数或金额按渠道统计；若选择"分子账号"，按子账号统计</small>
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-primary" onclick="addRoundRobinPlanRow()" style="margin-top: 24px;">添加计划</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Round Robin Plan Table -->
                            <div class="form-section" id="rr-plan-section" style="display: none;">
                                <h3 class="section-title">轮循计划配置</h3>
                                <div class="table-container">
                                    <table class="data-table" id="rr-plan-table">
                                        <thead>
                                            <tr>
                                                <th>支付方式</th>
                                                <th>渠道</th>
                                                <th>账号名</th>
                                                <th>类型</th>
                                                <th>优先备用渠道</th>
                                                <th>限制类型/值 <span style="color: red; font-size: 12px;">(二选一填)</span></th>
                                                <th>域名 <span class="required">*</span></th>
                                                <th>发送产品</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rr-plan-tbody">
                                            <!-- Rows will be added dynamically -->
                                        </tbody>
                                    </table>
                                    <div style="margin-top: 12px;">
                                        <button type="button" class="btn btn-secondary" onclick="addRoundRobinRow()">添加行</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Configuration (Collapsible) -->
                            <div class="form-section">
                                <h3 class="section-title" style="cursor: pointer;" onclick="toggleRoundRobinDetails()">
                                    详细配置 <span id="rr-details-toggle">▼</span>
                                </h3>
                                <div id="rr-details-content" style="display: none;">
                                    <div class="form-grid">
                                        <div class="form-group full-width">
                                            <label>域名 <span class="required">*</span></label>
                                            <input type="text" id="rr-domain" name="rrDomain" class="form-input" placeholder="checkout.example.com">
                                            <small class="form-hint">申请对应渠道时使用的域名，B站域名(需要 StarSaas 解析域名后才能使用，域名格式例如: checkout.example.com 或 api.example.com)，必填(注意域名格式)</small>
                                        </div>
                                        <div class="form-group">
                                            <label>时区</label>
                                            <select id="rr-timezone" name="rrTimezone" class="form-select">
                                                <option value="UTC+12:00" selected>UTC+12:00</option>
                                                <option value="UTC+8:00">UTC+8:00</option>
                                                <option value="UTC+0:00">UTC+0:00</option>
                                                <option value="UTC-5:00">UTC-5:00</option>
                                            </select>
                                            <small class="form-hint">可选择需要的时区计算轮询的总金额或总笔数，默认为UTC+12:00</small>
                                        </div>
                                        <div class="form-group">
                                            <label>订单号前缀</label>
                                            <input type="text" id="rr-order-prefix" name="rrOrderPrefix" class="form-input" placeholder="不允许有空格">
                                            <small class="form-hint">可自定义交易订单号的前缀(不允许有空格)，选填，默认为空</small>
                                        </div>
                                        <div class="form-group">
                                            <label>数字订单长度</label>
                                            <input type="number" id="rr-order-length" name="rrOrderLength" class="form-input" value="12" min="1" max="50">
                                            <small class="form-hint">可自定义交易订单号的长度，默认为12位</small>
                                        </div>
                                        <div class="form-group">
                                            <label>账单描述</label>
                                            <input type="text" id="rr-bill-desc" name="rrBillDesc" class="form-input">
                                            <small class="form-hint">可自定义发送给收单行的账单描述，与【域名替代描述】配合使用，默认发送为B站一级域名，选填</small>
                                        </div>
                                        <div class="form-group">
                                            <label>域名替代描述</label>
                                            <select id="rr-domain-replace" name="rrDomainReplace" class="form-select">
                                                <option value="no" selected>否</option>
                                                <option value="yes">是</option>
                                            </select>
                                            <small class="form-hint">若选择"是"，配置的【账单描述】会发送给收单行</small>
                                        </div>
                                        <div class="form-group">
                                            <label>优先级</label>
                                            <input type="number" id="rr-priority" name="rrPriority" class="form-input" value="1" min="1">
                                            <small class="form-hint">可选择配置轮循使用的优先级，默认为"1"</small>
                                        </div>
                                        <div class="form-group">
                                            <label>渠道限制(小时)</label>
                                            <input type="number" id="rr-channel-limit-hours" name="rrChannelLimitHours" class="form-input" min="0">
                                            <small class="form-hint">限制过去时间到当前时间的时间限制范围，选填</small>
                                        </div>
                                        <div class="form-group">
                                            <label>渠道限制(次数)</label>
                                            <input type="number" id="rr-channel-limit-times" name="rrChannelLimitTimes" class="form-input" min="0">
                                            <small class="form-hint">时间限制范围内的支付成功次数限制，选填。注意：与【渠道限制(小时)】需同时填写或同时留空</small>
                                        </div>
                                        <div class="form-group">
                                            <label>每笔最小金额(USD)</label>
                                            <input type="number" id="rr-min-amount" name="rrMinAmount" class="form-input" min="0" step="0.01">
                                            <small class="form-hint">每笔订单的金额(USD)不能小于设置的金额，选填</small>
                                        </div>
                                        <div class="form-group">
                                            <label>每笔最大金额(USD)</label>
                                            <input type="number" id="rr-max-amount" name="rrMaxAmount" class="form-input" min="0" step="0.01">
                                            <small class="form-hint">每笔订单的金额(USD)不能大于设置的金额，选填</small>
                                        </div>
                                        <div class="form-group">
                                            <label>币种</label>
                                            <select id="rr-currency" name="rrCurrency" class="form-select">
                                                <option value="">不限制</option>
                                                <option value="USD">USD</option>
                                                <option value="EUR">EUR</option>
                                                <option value="CNY">CNY</option>
                                                <option value="INR">INR</option>
                                            </select>
                                            <small class="form-hint">限制交易的币种，选填</small>
                                        </div>
                                        <div class="form-group">
                                            <label>卡种</label>
                                            <select id="rr-card-type" name="rrCardType" class="form-select">
                                                <option value="">不限制</option>
                                                <option value="Visa">Visa</option>
                                                <option value="Master">Master</option>
                                                <option value="Maestro">Maestro</option>
                                                <option value="JCB">JCB</option>
                                            </select>
                                            <small class="form-hint">限制交易的卡种，选填</small>
                                        </div>
                                        <div class="form-group">
                                            <label>卡BIN国家</label>
                                            <input type="text" id="rr-card-bin-country" name="rrCardBinCountry" class="form-input">
                                            <small class="form-hint">限制交易的卡BIN国家，选填</small>
                                        </div>
                                        <div class="form-group">
                                            <label>是否匹配A站域名</label>
                                            <select id="rr-match-a-domain" name="rrMatchADomain" class="form-select">
                                                <option value="no" selected>否</option>
                                                <option value="yes">是</option>
                                            </select>
                                            <small class="form-hint">商户交易请求进来后，使用A站域名匹配轮循中的B站域名，若有匹配成功的轮循，则使用该轮循请求渠道，默认"否"</small>
                                        </div>
                                        <div class="form-group">
                                            <label>是否匹配地址</label>
                                            <select id="rr-match-address" name="rrMatchAddress" class="form-select">
                                                <option value="no" selected>否</option>
                                                <option value="yes">是</option>
                                            </select>
                                            <small class="form-hint">匹配虚拟的交易地址，默认"否"。需要轮循计划中支付方式为"Credit Card"且绑定接口类型为"2方直连"（见上方"网关接入号设置"）</small>
                                        </div>
                                        <div class="form-group">
                                            <label>是否加载渠道JS</label>
                                            <select id="rr-load-channel-js" name="rrLoadChannelJS" class="form-select">
                                                <option value="no" selected>否</option>
                                                <option value="yes">是</option>
                                            </select>
                                            <small class="form-hint">用于特殊收单行(例如Airwallex)收集用户设备信息，默认"否"</small>
                                        </div>
                                        <div class="form-group full-width">
                                            <label>单MID限制(天)</label>
                                            <input type="number" id="rr-single-mid-limit" name="rrSingleMidLimit" class="form-input" min="0">
                                            <small class="form-hint">限制级相同邮箱或卡号，同一渠道多账号在一段时间内仅允许在其中一个账号请求一次，选填</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gateway Access Number Settings (Steps 5-7) - After Detailed Configuration -->
                            <div class="form-section" id="gateway-settings-section" style="display: none;">
                                <h3 class="section-title" style="cursor: pointer;" onclick="toggleGatewaySettings()">
                                    网关接入号设置 <span id="gateway-settings-toggle">▼</span>
                                </h3>
                                <div id="gateway-settings-content" style="display: none;">
                                    <div class="info-box" style="margin-bottom: 20px;">
                                        <p><strong>提示：</strong>轮循详细配置完成后，请配置以下网关接入号设置。这些设置可在此页面直接配置，无需跳转到"商户维护"页面。</p>
                                    </div>
                                    <div class="form-grid">
                                        <!-- Step 5: Use Platform Transaction Order Number -->
                                        <div class="form-group">
                                            <label>使用平台交易订单号 <span class="required">*</span></label>
                                            <div style="display: flex; gap: 16px; align-items: center; margin-top: 8px;">
                                                <label class="radio-label">
                                                    <input type="radio" id="rr-use-platform-order-yes" name="rrUsePlatformOrder" value="yes" checked>
                                                    <span>是</span>
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" id="rr-use-platform-order-no" name="rrUsePlatformOrder" value="no">
                                                    <span>否</span>
                                                </label>
                                            </div>
                                            <small class="form-hint">轮循详细配置完成后，需要选择"是"，轮循中设置的自定义交易订单号（订单号前缀和数字订单长度）才能生效</small>
                                        </div>

                                        <!-- Step 6: Merchant Domain Binding for IFrame -->
                                        <div class="form-group">
                                            <label>商户域名绑定 (IFrame模式)</label>
                                            <select id="rr-merchant-domain-binding" name="rrMerchantDomainBinding" class="form-select">
                                                <option value="">请选择</option>
                                                <option value="iframe-payment-page-new">IFrame Payment Page New</option>
                                                <option value="other">其他</option>
                                            </select>
                                            <small class="form-hint">如果 IFrame 模式交易配置轮循，需要设置为"IFrame Payment Page New"</small>
                                        </div>

                                        <!-- Step 7: Binding Interface Type -->
                                        <div class="form-group">
                                            <label>绑定接口类型</label>
                                            <select id="rr-binding-interface-type" name="rrBindingInterfaceType" class="form-select">
                                                <option value="">请选择</option>
                                                <option value="2-party">2方直连</option>
                                                <option value="3-party">3方</option>
                                                <option value="other">其他</option>
                                            </select>
                                            <small class="form-hint">限制卡种交易、渠道限制地址和是否匹配地址需要子账号绑定接口类型配置为"2方直连"</small>
                                        </div>

                                        <!-- Step 7: Restricted Card Types Transaction (conditional) -->
                                        <div class="form-group" id="rr-restricted-card-types-group" style="display: none;">
                                            <label>限制卡种交易</label>
                                            <select id="rr-restricted-card-types" name="rrRestrictedCardTypes" class="form-select" multiple>
                                                <option value="visa">Visa</option>
                                                <option value="master">Master</option>
                                                <option value="maestro">Maestro</option>
                                                <option value="jcb">JCB</option>
                                                <option value="ae">American Express</option>
                                                <option value="diners">Diners</option>
                                                <option value="discover">Discover</option>
                                            </select>
                                            <small class="form-hint">选择需要限制的卡种，可多选。需要支付方式为"Credit Card"且绑定接口类型为"2方直连"</small>
                                        </div>

                                        <!-- Step 7: Channel Restricted Address (conditional) -->
                                        <div class="form-group full-width" id="rr-channel-restricted-address-group" style="display: none;">
                                            <label>渠道限制地址</label>
                                            <input type="text" id="rr-channel-restricted-address" name="rrChannelRestrictedAddress" class="form-input" placeholder="输入限制的地址，多个地址用逗号分隔">
                                            <small class="form-hint">限制交易的地址，多个地址用逗号分隔。需要支付方式为"Credit Card"且绑定接口类型为"2方直连"</small>
                                        </div>
                                    </div>
                                    <div class="info-box" style="margin-top: 16px; background: #fff3cd; border-color: #ffc107;">
                                        <p><strong>注意：</strong>限制卡种交易、渠道限制地址和是否匹配地址需要支付方式为"Credit Card"（在轮循计划表中配置）且绑定接口类型为"2方直连"。</p>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Connection Test Options -->
                        <div class="connection-test-options" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                            <label class="connection-test-checkbox-label">
                                <input type="checkbox" id="performConnectionTest" name="performConnectionTest" checked>
                                <span>保存配置后执行连接测试</span>
                            </label>
                            
                            <!-- Saved Connection Test Result -->
                            <div id="savedConnectionTestResult" class="saved-connection-test-result" style="display: none; margin-top: 12px;">
                                <div class="saved-result-header">
                                    <span class="saved-result-label">上次连接测试：</span>
                                </div>
                                <div class="saved-result-content">
                                    <span class="saved-result-date" id="savedTestDate"></span>
                                    <span class="saved-result-status" id="savedTestStatus"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection Test Status (Live) -->
                        <div id="connectionTestStatus" class="connection-test-status" style="display: none;">
                            <div class="connection-test-content">
                                <span class="connection-test-icon" id="connectionTestIcon"></span>
                                <span class="connection-test-text" id="connectionTestText"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="resetRoundRobinForm()">重置</button>
                        <button type="button" class="btn btn-primary" onclick="submitRoundRobinForm()">提交</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab 2: Round Robin -->

        <!-- Tab 4: Analysis -->
        <div class="tab-content" id="analysis-tab" style="display: none;">
            <div class="config-card">
                <div class="card-body">
                    <!-- Filters -->
                    <div class="analysis-header">
                        <div class="analysis-filters">
                            <div class="analysis-filters-row">
                                <div class="analysis-filter-item">
                                    <label for="timePeriodSelect">时间范围:</label>
                                    <select id="timePeriodSelect" name="timePeriod" class="form-select" onchange="loadAnalysisData()">
                                        <option value="last-week">最近一周</option>
                                        <option value="last-month" selected>最近一月</option>
                                        <option value="all-time">全部时间</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="analysisMerchantSelect">商户:</label>
                                    <select id="analysisMerchantSelect" name="merchant" class="form-select" onchange="loadAnalysisData()">
                                        <option value="">请选择商户</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="analysisSubMerchantSelect">子商户:</label>
                                    <select id="analysisSubMerchantSelect" name="subMerchant" class="form-select" onchange="loadAnalysisData()">
                                        <option value="">请选择子商户</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="analysisChannelSelect">渠道:</label>
                                    <select id="analysisChannelSelect" name="channel" class="form-select" onchange="loadAnalysisData()">
                                        <option value="">请选择渠道</option>
                                        <option value="ysepay">YSEPAY</option>
                                        <option value="rumble">RUMBLE</option>
                                        <option value="evonet">EVONET</option>
                                        <option value="paysaas">PAYSAAS</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="analysisPlatformSelect">平台:</label>
                                    <select id="analysisPlatformSelect" name="platform" class="form-select" onchange="loadAnalysisData()">
                                        <option value="">请选择平台</option>
                                        <option value="shopyy">ShopYY</option>
                                        <option value="shopline">Shopline</option>
                                        <option value="shoplazza">Shoplazza</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <button type="button" class="btn btn-secondary" onclick="resetAnalysisFilters()">重置筛选</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="analysis-summary-cards">
                        <div class="summary-card">
                            <div class="summary-card-icon" style="background: #e3f2fd;">
                                <span style="font-size: 24px;">📊</span>
                            </div>
                            <div class="summary-card-content">
                                <div class="summary-card-label">总交易数</div>
                                <div class="summary-card-value" id="totalTransactions">0</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon" style="background: #e8f5e9;">
                                <span style="font-size: 24px;">✓</span>
                            </div>
                            <div class="summary-card-content">
                                <div class="summary-card-label">批准率</div>
                                <div class="summary-card-value" id="approvalRate">0%</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon" style="background: #fff3e0;">
                                <span style="font-size: 24px;">⚠</span>
                            </div>
                            <div class="summary-card-content">
                                <div class="summary-card-label">失败交易</div>
                                <div class="summary-card-value" id="failedTransactions">0</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-icon" style="background: #fce4ec;">
                                <span style="font-size: 24px;">❌</span>
                            </div>
                            <div class="summary-card-content">
                                <div class="summary-card-label">拒绝交易</div>
                                <div class="summary-card-value" id="rejectedTransactions">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Statistics -->
                    <div class="analysis-section">
                        <h3 class="section-title">交易统计</h3>
                        <div class="table-container">
                            <table class="data-table" id="transactionStatsTable">
                                <thead>
                                    <tr>
                                        <th>渠道</th>
                                        <th>交易数</th>
                                        <th>成功数</th>
                                        <th>失败数</th>
                                        <th>拒绝数</th>
                                        <th>成功率</th>
                                        <th>详细</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionStatsBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Failed/Rejection Reasons -->
                    <div class="analysis-section" id="rejectionReasonsSection" style="display: none;">
                        <h3 class="section-title">失败/拒绝原因分析</h3>
                        <div class="table-container">
                            <table class="data-table" id="rejectionReasonsTable">
                                <thead>
                                    <tr>
                                        <th>原因</th>
                                        <th>数量</th>
                                        <th>占比</th>
                                        <th>详情</th>
                                    </tr>
                                </thead>
                                <tbody id="rejectionReasonsBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 40px; color: #999;">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab 4: Analysis -->
        
        <!-- Tab 5: Charts -->
        <div class="tab-content" id="charts-tab" style="display: none;">
            <div class="config-card">
                <div class="card-body">
                    <!-- Filters (same as Analysis tab) -->
                    <div class="analysis-header">
                        <div class="analysis-filters">
                            <div class="analysis-filters-row">
                                <div class="analysis-filter-item">
                                    <label for="chartTimePeriodSelect">时间范围:</label>
                                    <select id="chartTimePeriodSelect" name="timePeriod" class="form-select" onchange="loadChartData()">
                                        <option value="last-week">最近一周</option>
                                        <option value="last-month" selected>最近一月</option>
                                        <option value="all-time">全部时间</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="chartMerchantSelect">商户:</label>
                                    <select id="chartMerchantSelect" name="merchant" class="form-select" onchange="loadChartData()">
                                        <option value="">请选择商户</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="chartSubMerchantSelect">子商户:</label>
                                    <select id="chartSubMerchantSelect" name="subMerchant" class="form-select" onchange="loadChartData()">
                                        <option value="">请选择子商户</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="chartChannelSelect">渠道:</label>
                                    <select id="chartChannelSelect" name="channel" class="form-select" onchange="loadChartData()">
                                        <option value="">请选择渠道</option>
                                        <option value="ysepay">YSEPAY</option>
                                        <option value="rumble">RUMBLE</option>
                                        <option value="evonet">EVONET</option>
                                        <option value="paysaas">PAYSAAS</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <label for="chartPlatformSelect">平台:</label>
                                    <select id="chartPlatformSelect" name="platform" class="form-select" onchange="loadChartData()">
                                        <option value="">请选择平台</option>
                                        <option value="shopyy">ShopYY</option>
                                        <option value="shopline">Shopline</option>
                                        <option value="shoplazza">Shoplazza</option>
                                    </select>
                                </div>
                                <div class="analysis-filter-item">
                                    <button type="button" class="btn btn-secondary" onclick="resetChartFilters()">重置筛选</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="charts-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px;">
                        <!-- Chart 1: Transaction Statistics by Channel -->
                        <div class="chart-card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 class="section-title" style="margin-bottom: 20px; font-size: 18px; font-weight: 600;">渠道交易统计</h3>
                            <canvas id="channelStatsChart" style="max-height: 300px;"></canvas>
                        </div>

                        <!-- Chart 2: Success/Failure/Rejection Rate -->
                        <div class="chart-card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 class="section-title" style="margin-bottom: 20px; font-size: 18px; font-weight: 600;">交易状态分布</h3>
                            <canvas id="transactionStatusChart" style="max-height: 300px;"></canvas>
                        </div>

                        <!-- Chart 3: Rejection Reasons -->
                        <div class="chart-card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 class="section-title" style="margin-bottom: 20px; font-size: 18px; font-weight: 600;">拒绝原因分析</h3>
                            <canvas id="rejectionReasonsChart" style="max-height: 300px;"></canvas>
                        </div>

                        <!-- Chart 4: Success Rate by Channel -->
                        <div class="chart-card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h3 class="section-title" style="margin-bottom: 20px; font-size: 18px; font-weight: 600;">渠道成功率对比</h3>
                            <canvas id="successRateChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab 5: Charts -->
    </div>

    <!-- Rejection Details Modal -->
    <div id="rejectionDetailsModal" class="rejection-modal" style="display: none;">
        <div class="rejection-modal-content">
            <div class="rejection-modal-header">
                <h3 id="rejectionModalTitle">拒绝详情</h3>
                <button class="rejection-modal-close" onclick="closeRejectionModal()">&times;</button>
            </div>
            <div class="rejection-modal-body">
                <div class="rejection-detail-section">
                    <h4>拒绝原因</h4>
                    <p id="rejectionDetailReason" class="rejection-detail-text"></p>
                </div>
                <div class="rejection-detail-section">
                    <h4>银行响应详情</h4>
                    <div id="rejectionDetailBankResponse" class="rejection-detail-code"></div>
                </div>
                <div class="rejection-detail-section">
                    <h4>响应代码</h4>
                    <p id="rejectionDetailCode" class="rejection-detail-text"></p>
                </div>
                <div class="rejection-detail-section">
                    <h4>示例交易</h4>
                    <div id="rejectionDetailTransactions" class="rejection-detail-transactions"></div>
                </div>
            </div>
            <div class="rejection-modal-footer">
                <button class="btn btn-primary" onclick="closeRejectionModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">配置中，请稍候...</div>
    </div>

    <!-- Full Hint Modal -->
    <div id="fullHintModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>渠道配置指南</h2>
                <button class="modal-close" onclick="closeFullHintModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <div id="fullHintImageContainer"></div>
                <div id="fullHintTextContainer" style="margin-top: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeFullHintModal()">关闭</button>
            </div>
        </div>
    </div>

        </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script src="sidebar-menu.js"></script>
    <script src="channel-binding-config.js"></script>
    
    <script>
        // Round Robin Configuration JavaScript
        
        let roundRobinData = [];
        let currentEditingRoundRobin = null;
        let roundRobinRowCounter = 0;

        // Tab Switching
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }
            
            const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            if (tabName === 'round-robin') {
                loadRoundRobinList();
            }
            
            if (tabName === 'charts') {
                // Wait a bit for the tab to be visible, then initialize charts
                setTimeout(() => {
                    if (typeof initChartFilters === 'function') {
                        initChartFilters();
                    }
                    if (typeof loadChartData === 'function') {
                        loadChartData();
                    }
                }, 100);
            }
            
            if (tabName === 'analysis') {
                // Initialize analysis filters if not already done
                if (typeof initAnalysisFilters === 'function') {
                    initAnalysisFilters();
                }
                if (typeof loadAnalysisData === 'function') {
                    loadAnalysisData();
                }
            }
            
            if (tabName === 'analysis') {
                // Initialize filters when switching to analysis tab
                if (document.getElementById('analysisMerchantSelect').options.length === 1) {
                    initAnalysisFilters();
                }
                loadAnalysisData();
            }
        };

        // Platform Configuration
        const platformHintImages = {
            'shopyy-direct': 'ShopYY_直连配置指南.png',
            'shopyy-redirect': 'ShopYY_跳转配置指南.png',
            'shopline-direct': 'Shopline平台配置指南_直连.png',
            'shopline-redirect': 'Shopline平台配置指南_跳转.png',
            'shoplazza-direct': 'Shoplazza平台配置指南_直连.png',
            'shoplazza-redirect': 'Shoplazza平台配置指南_跳转.png'
        };

        // Load Platform Hint
        async function loadPlatformHint(platform, interfaceType) {
            if (!platform || !interfaceType) {
                document.getElementById('platform-hint-section').style.display = 'none';
                return;
            }

            try {
                // Try to load from API first
                const response = await fetch(`/api/platform-hint/${platform}/${interfaceType}`, {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.fileData || data.imageUrl) {
                        document.getElementById('platform-hint-section').style.display = 'block';
                        document.getElementById('platformHintDisplay').style.display = 'block';
                        
                        const fileData = data.fileData || data.imageData || data.imageUrl;
                        // Determine file type - check explicit fileType first, then check data URL prefix
                        let fileType = 'image';
                        if (data.fileType) {
                            fileType = data.fileType;
                        } else if (fileData) {
                            // Check if it's a PDF data URL
                            if (fileData.startsWith('data:application/pdf') || fileData.includes('application/pdf')) {
                                fileType = 'pdf';
                            } else if (fileData.startsWith('data:image/')) {
                                fileType = 'image';
                            }
                        }
                        const fileName = data.fileName || '';
                        
                        displayPlatformHint(fileData, fileType, fileName, data.textHint || '');
                        return;
                    }
                }
            } catch (error) {
                console.warn('Failed to load platform hint from API:', error);
            }
            
            // Fallback: Try localStorage
            try {
                const key = `platformHint_${platform}_${interfaceType}`;
                const stored = localStorage.getItem(key);
                if (stored) {
                    const data = JSON.parse(stored);
                    const fileData = data.fileData || data.imageData || data.imageUrl;
                    
                    if (fileData) {
                        let fileType = 'image';
                        if (data.fileType) {
                            fileType = data.fileType;
                        } else if (fileData) {
                            // Check if it's a PDF data URL
                            if (fileData.startsWith('data:application/pdf') || fileData.includes('application/pdf')) {
                                fileType = 'pdf';
                            } else if (fileData.startsWith('data:image/')) {
                                fileType = 'image';
                            }
                        }
                        const fileName = data.fileName || '';
                        
                        document.getElementById('platform-hint-section').style.display = 'block';
                        document.getElementById('platformHintDisplay').style.display = 'block';
                        
                        displayPlatformHint(fileData, fileType, fileName, data.textHint || '');
                        console.log('Loaded platform hint from localStorage:', { platform, interfaceType, fileType, fileName });
                        return;
                    }
                }
            } catch (e) {
                console.warn('Failed to load platform hint from localStorage:', e);
            }

            // Final fallback: use local image files
            const key = `${platform}-${interfaceType}`;
            const imageName = platformHintImages[key];
            
            if (!imageName) {
                document.getElementById('platform-hint-section').style.display = 'none';
                return;
            }

            document.getElementById('platform-hint-section').style.display = 'block';
            document.getElementById('platformHintDisplay').style.display = 'block';

            // Load hint from API or use local image
            const imagePath = imageName; // In production, this would come from API
            
            // Set thumbnail
            const thumbnail = document.getElementById('platformHintThumbnail');
            thumbnail.innerHTML = `<img src="${imagePath}" alt="Platform Configuration Guide" onclick="expandPlatformHint()" style="max-width: 100%; max-height: 200px; border-radius: 4px; cursor: pointer;">`;
            
            // Set full image
            const imageContainer = document.getElementById('platformHintImageContainer');
            imageContainer.innerHTML = `<img src="${imagePath}" alt="Platform Configuration Guide" style="max-width: 100%; border-radius: 4px;">`;
            
            // Load text hint from API (if available)
            loadPlatformTextHint(platform, interfaceType);
        }

        // Display Platform Hint
        function displayPlatformHint(fileData, fileType, fileName, textHint) {
            const thumbnail = document.getElementById('platformHintThumbnail');
            const imageContainer = document.getElementById('platformHintImageContainer');
            const textPreview = document.getElementById('platformHintTextPreview');
            const textFull = document.getElementById('platformHintTextFull');
            
            if (fileType === 'pdf') {
                // Display PDF
                if (thumbnail) {
                    // Escape quotes in fileData for onclick attribute
                    const escapedFileData = fileData.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const escapedFileName = (fileName || 'document.pdf').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    thumbnail.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 4px; cursor: pointer;" onclick="previewPDFInModal('${escapedFileData}', '${escapedFileName}')">
                            <div style="font-size: 32px;">📄</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #4A90E2; margin-bottom: 4px;">${fileName || 'document.pdf'}</div>
                                <div style="font-size: 12px; color: #666;">点击预览 PDF 文件</div>
                            </div>
                        </div>
                    `;
                }
                if (imageContainer) {
                    // Escape quotes in fileData for onclick attribute
                    const escapedFileData = fileData.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const escapedFileName = (fileName || 'document.pdf').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    imageContainer.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: #f8f9fa; border-radius: 4px; cursor: pointer; margin-bottom: 16px;" onclick="previewPDFInModal('${escapedFileData}', '${escapedFileName}')">
                            <div style="font-size: 48px;">📄</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #4A90E2; font-size: 18px; margin-bottom: 8px;">${fileName || 'document.pdf'}</div>
                                <div style="font-size: 14px; color: #666;">点击此处预览 PDF 文件内容</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Display image
                if (thumbnail) {
                    thumbnail.innerHTML = `<img src="${fileData}" alt="Platform Configuration Guide" onclick="expandPlatformHint()" style="max-width: 100%; max-height: 200px; border-radius: 4px; cursor: pointer;">`;
                }
                if (imageContainer) {
                    imageContainer.innerHTML = `<img src="${fileData}" alt="Platform Configuration Guide" style="max-width: 100%; border-radius: 4px;">`;
                }
            }
            
            if (textHint) {
                const truncated = textHint.length > 100 ? textHint.substring(0, 100) + '...' : textHint;
                if (textPreview) {
                    textPreview.innerHTML = `<p>${truncated.replace(/\n/g, '<br>')}</p>`;
                }
                if (textFull) {
                    textFull.innerHTML = `<p>${textHint.replace(/\n/g, '<br>')}</p>`;
                }
            }
        }

        // Load Platform Text Hint
        async function loadPlatformTextHint(platform, interfaceType) {
            try {
                const response = await fetch(`/api/platform-hint/${platform}/${interfaceType}`, {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.textHint) {
                        document.getElementById('platformHintTextPreview').innerHTML = `<p>${data.textHint.substring(0, 100)}...</p>`;
                        document.getElementById('platformHintTextFull').innerHTML = `<p>${data.textHint}</p>`;
                    }
                }
            } catch (error) {
                console.warn('Failed to load platform text hint:', error);
            }
        }

        // Toggle Platform Hint Expansion
        window.togglePlatformHintExpansion = function() {
            const collapsed = document.getElementById('platformHintContentCollapsed');
            const expanded = document.getElementById('platformHintContentExpanded');
            const toggleText = document.getElementById('platformHintToggleText');
            const arrow = collapsed.parentElement.querySelector('.hint-arrow');
            
            if (expanded.style.display === 'none') {
                collapsed.style.display = 'none';
                expanded.style.display = 'block';
                toggleText.textContent = '收起';
                if (arrow) arrow.textContent = '▲';
            } else {
                collapsed.style.display = 'block';
                expanded.style.display = 'none';
                toggleText.textContent = '展开查看';
                if (arrow) arrow.textContent = '▼';
            }
        };

        // Expand Platform Hint (click on thumbnail)
        window.expandPlatformHint = function() {
            togglePlatformHintExpansion();
        };

        // Load Platform Merchant Options
        async function loadPlatformMerchantOptions() {
            try {
                const response = await fetch('/api/merchants/list', {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    const data = await response.json();
                    const merchantSelect = document.getElementById('platform-merchant-name');
                    if (merchantSelect && data.merchants) {
                        merchantSelect.innerHTML = '<option value="">请选择商户名</option>';
                        data.merchants.forEach(merchant => {
                            const option = document.createElement('option');
                            option.value = merchant.id;
                            option.textContent = merchant.name;
                            merchantSelect.appendChild(option);
                        });
                    }
                } else {
                    // Fallback: use same merchants as channel binding form
                    const mainMerchantSelect = document.getElementById('merchant-name');
                    const platformMerchantSelect = document.getElementById('platform-merchant-name');
                    if (mainMerchantSelect && platformMerchantSelect) {
                        const options = Array.from(mainMerchantSelect.options);
                        platformMerchantSelect.innerHTML = '<option value="">请选择商户名</option>';
                        options.forEach(option => {
                            if (option.value) {
                                const newOption = option.cloneNode(true);
                                platformMerchantSelect.appendChild(newOption);
                            }
                        });
                    }
                }
            } catch (error) {
                console.warn('Failed to load platform merchants:', error);
                // Fallback: use same merchants as channel binding form
                const mainMerchantSelect = document.getElementById('merchant-name');
                const platformMerchantSelect = document.getElementById('platform-merchant-name');
                if (mainMerchantSelect && platformMerchantSelect) {
                    const options = Array.from(mainMerchantSelect.options);
                    platformMerchantSelect.innerHTML = '<option value="">请选择商户名</option>';
                    options.forEach(option => {
                        if (option.value) {
                            const newOption = option.cloneNode(true);
                            platformMerchantSelect.appendChild(newOption);
                        }
                    });
                }
            }
        }

        // Load Platform Sub Accounts
        async function loadPlatformSubAccounts(merchantId) {
            const subAccountSelect = document.getElementById('platform-sub-account');
            if (!subAccountSelect) return;

            if (!merchantId) {
                subAccountSelect.innerHTML = '<option value="">请选择子账号</option>';
                subAccountSelect.disabled = true;
                return;
            }

            try {
                const response = await fetch(`/api/merchants/${merchantId}/sub-accounts`, {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.subAccounts && data.subAccounts.length > 0) {
                        subAccountSelect.innerHTML = '<option value="">请选择子账号</option>';
                        data.subAccounts.forEach(subAccount => {
                            const option = document.createElement('option');
                            option.value = subAccount.id;
                            option.textContent = subAccount.name;
                            subAccountSelect.appendChild(option);
                        });
                        subAccountSelect.disabled = false;
                        return;
                    }
                }
            } catch (error) {
                console.warn('Failed to load platform sub-accounts:', error);
            }

            // Fallback: try to get from main form if same merchant
            const mainMerchantSelect = document.getElementById('merchant-name');
            const mainSubAccountSelect = document.getElementById('sub-account');
            
            if (mainMerchantSelect && mainSubAccountSelect && mainMerchantSelect.value === merchantId) {
                const options = Array.from(mainSubAccountSelect.options);
                subAccountSelect.innerHTML = '<option value="">请选择子账号</option>';
                options.forEach(option => {
                    if (option.value) {
                        const newOption = option.cloneNode(true);
                        subAccountSelect.appendChild(newOption);
                    }
                });
                subAccountSelect.disabled = false;
            } else {
                // Fallback: use mock data
                subAccountSelect.innerHTML = '<option value="">请选择子账号</option>';
                const mockSubAccounts = [
                    { id: 'sub1', name: 'STARSAAS' },
                    { id: 'sub2', name: 'Sub Account 2' },
                    { id: 'sub3', name: 'Sub Account 3' }
                ];
                mockSubAccounts.forEach(subAccount => {
                    const option = document.createElement('option');
                    option.value = subAccount.id;
                    option.textContent = subAccount.name;
                    subAccountSelect.appendChild(option);
                });
                subAccountSelect.disabled = false;
            }
        }

        // Platform and Interface Type Change Handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Load merchant options for platform config
            loadPlatformMerchantOptions();

            // Setup merchant change handler
            const platformMerchantSelect = document.getElementById('platform-merchant-name');
            if (platformMerchantSelect) {
                platformMerchantSelect.addEventListener('change', function() {
                    loadPlatformSubAccounts(this.value);
                });
            }

            const platformSelect = document.getElementById('platform-select');
            const interfaceTypeSelect = document.getElementById('interface-type-select');
            
            function updatePlatformConfig() {
                const platform = platformSelect.value;
                const interfaceType = interfaceTypeSelect.value;
                
                // Load hint
                loadPlatformHint(platform, interfaceType);
                
                // Show/hide form fields
                updatePlatformFormFields(platform, interfaceType);
            }
            
            if (platformSelect) {
                platformSelect.addEventListener('change', updatePlatformConfig);
            }
            if (interfaceTypeSelect) {
                interfaceTypeSelect.addEventListener('change', updatePlatformConfig);
            }
        });

        // Update Platform Form Fields
        function updatePlatformFormFields(platform, interfaceType) {
            // Hide all platform config fields
            document.querySelectorAll('.platform-config-fields').forEach(field => {
                field.style.display = 'none';
            });
            
            // Hide sections if no selection
            if (!platform || !interfaceType) {
                document.getElementById('platform-hint-section').style.display = 'none';
                document.getElementById('platform-config-fields-section').style.display = 'none';
                return;
            }
            
            // Show hint section
            document.getElementById('platform-hint-section').style.display = 'block';
            
            // Show config fields section
            document.getElementById('platform-config-fields-section').style.display = 'block';
            
            // Show appropriate form fields
            const fieldId = `${platform}-${interfaceType}-fields`;
            const fieldsElement = document.getElementById(fieldId);
            if (fieldsElement) {
                fieldsElement.style.display = 'block';
                // Setup password toggle for newly shown fields
                setupPlatformPasswordToggles(fieldId);
            }
        }

        // Setup Password Toggles for Platform Fields
        function setupPlatformPasswordToggles(fieldId) {
            const fieldsElement = document.getElementById(fieldId);
            if (!fieldsElement) return;
            
            // Use event delegation for password toggles
            fieldsElement.addEventListener('click', function(e) {
                if (e.target.classList.contains('toggle-password')) {
                    const targetId = e.target.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);
                    if (targetInput) {
                        if (targetInput.type === 'password') {
                            targetInput.type = 'text';
                            e.target.textContent = '🙈';
                        } else {
                            targetInput.type = 'password';
                            e.target.textContent = '👁️';
                        }
                    }
                }
            });
        }

        // Reset Platform Form
        window.resetPlatformForm = function() {
            document.getElementById('platform-config-form').reset();
            document.getElementById('platform-merchant-name').value = '';
            document.getElementById('platform-sub-account').value = '';
            document.getElementById('platform-sub-account').disabled = true;
            document.getElementById('platform-select').value = '';
            document.getElementById('interface-type-select').value = '';
            document.getElementById('platform-hint-section').style.display = 'none';
            document.getElementById('platform-config-fields-section').style.display = 'none';
            document.querySelectorAll('.platform-config-fields').forEach(field => {
                field.style.display = 'none';
            });
        };

        // Submit Platform Config
        window.submitPlatformConfig = async function() {
            const form = document.getElementById('platform-config-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const merchantId = document.getElementById('platform-merchant-name').value;
            const subAccountId = document.getElementById('platform-sub-account').value;
            const platform = document.getElementById('platform-select').value;
            const interfaceType = document.getElementById('interface-type-select').value;
            
            if (!merchantId || !subAccountId) {
                alert('请选择商户名和子账号');
                return;
            }
            
            if (!platform || !interfaceType) {
                alert('请选择平台和接口类型');
                return;
            }

            // Collect form data based on platform and interface type
            const fieldId = `${platform}-${interfaceType}-fields`;
            const fieldsElement = document.getElementById(fieldId);
            if (!fieldsElement) {
                alert('无法找到配置字段');
                return;
            }

            // Collect form data based on platform and interface type
            const formData = {
                merchantId: merchantId,
                subAccountId: subAccountId,
                platform: platform,
                interfaceType: interfaceType,
                bindInterfaceType: document.getElementById(`${platform}-${interfaceType}-bind-interface-type`)?.value || '',
                platformSource: document.getElementById(`${platform}-${interfaceType}-platform-source`)?.value || ''
            };
            
            // Collect platform-specific additional fields for redirect types
            if (interfaceType === 'redirect') {
                formData.merchantDomain = document.getElementById(`${platform}-redirect-merchant-domain`)?.value || '';
            }

            // Validate required fields
            if (!formData.bindInterfaceType || !formData.platformSource) {
                alert('请填写所有必填字段（绑定接口类型、平台来源）');
                return;
            }

            try {
                const response = await fetch('/api/platform-config/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('平台配置保存成功！');
                    resetPlatformForm();
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Save platform config error:', error);
                // Fallback: save to localStorage
                const key = `platformConfig_${platform}_${interfaceType}`;
                localStorage.setItem(key, JSON.stringify(formData));
                alert('平台配置已保存到本地（演示模式）');
                resetPlatformForm();
            }
        };

        // Load Round Robin List
        async function loadRoundRobinList() {
            try {
                const response = await fetch('/api/round-robin/list', {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    roundRobinData = data.roundRobins || [];
                    renderRoundRobinList();
                } else {
                    // Fallback: load from localStorage
                    const stored = localStorage.getItem('roundRobinList');
                    if (stored) {
                        roundRobinData = JSON.parse(stored);
                        renderRoundRobinList();
                    }
                }
            } catch (error) {
                console.warn('Failed to load round robin list:', error);
                const stored = localStorage.getItem('roundRobinList');
                if (stored) {
                    roundRobinData = JSON.parse(stored);
                    renderRoundRobinList();
                }
            }
        }

        // Render Round Robin List
        function renderRoundRobinList() {
            const tbody = document.getElementById('roundrobin-list-tbody');
            if (!tbody) return;

            if (roundRobinData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">暂无轮循配置，请点击【新增】按钮添加</td></tr>';
                return;
            }

            tbody.innerHTML = roundRobinData.map((rr, index) => `
                <tr data-id="${rr.id || index}" onclick="selectRoundRobinRow(this)">
                    <td><input type="checkbox" onclick="event.stopPropagation();"></td>
                    <td>${rr.merchantName || rr.merchantId}</td>
                    <td>${rr.subAccountName || rr.subAccountId}</td>
                    <td>${rr.type === 'by-channel' ? '分渠道名' : '分子账号'}</td>
                    <td>${rr.paymentMethod || '-'}</td>
                    <td>${rr.channelName || '-'}</td>
                    <td>${rr.maxDailyCount || '-'}</td>
                    <td>${rr.maxDailyAmount || '-'}</td>
                    <td>${rr.domain || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteRoundRobin(${rr.id || index})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        // Select Round Robin Row
        window.selectRoundRobinRow = function(row) {
            document.querySelectorAll('#roundrobin-list-tbody tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            document.getElementById('editRoundRobinBtn').disabled = false;
        };

        // Add Round Robin Plan
        window.addRoundRobinPlan = function() {
            currentEditingRoundRobin = null;
            document.getElementById('roundrobin-modal-title').textContent = '新增商户收单其他';
            resetRoundRobinForm();
            loadMerchantsForRoundRobin();
            document.getElementById('roundrobin-modal').style.display = 'flex';
            // Setup event listeners for conditional fields
            setupGatewaySettingsListeners();
            // Hide saved connection test result for new form
            const savedResult = document.getElementById('savedConnectionTestResult');
            if (savedResult) {
                savedResult.style.display = 'none';
            }
        };

        // Edit Round Robin Plan
        window.editRoundRobinPlan = async function() {
            const selectedRow = document.querySelector('#roundrobin-list-tbody tr.selected');
            if (!selectedRow) {
                alert('请先选择要修改的记录');
                return;
            }
            
            const id = selectedRow.dataset.id;
            const rr = roundRobinData.find(r => (r.id || roundRobinData.indexOf(r)).toString() === id);
            if (!rr) return;

            currentEditingRoundRobin = rr;
            document.getElementById('roundrobin-modal-title').textContent = '修改商户收单其他';
            await loadMerchantsForRoundRobin();
            await fillRoundRobinForm(rr);
            document.getElementById('roundrobin-modal').style.display = 'flex';
            // Setup event listeners for conditional fields
            setupGatewaySettingsListeners();
            // Load saved connection test result
            loadSavedConnectionTestResult();
        };

        // Load Merchants for Round Robin
        async function loadMerchantsForRoundRobin() {
            const merchantSelect = document.getElementById('rr-merchant');
            const mainMerchantSelect = document.getElementById('merchant-name');
            
            // Remove existing event listeners by cloning the element
            const newMerchantSelect = merchantSelect.cloneNode(true);
            merchantSelect.parentNode.replaceChild(newMerchantSelect, merchantSelect);
            
            // Load merchants
            if (mainMerchantSelect) {
                const options = Array.from(mainMerchantSelect.options);
                newMerchantSelect.innerHTML = '<option value="">请选择</option>';
                options.forEach(option => {
                    if (option.value) {
                        const newOption = option.cloneNode(true);
                        newMerchantSelect.appendChild(newOption);
                    }
                });
            } else {
                // If main form doesn't exist, try to load from mock data or API
                newMerchantSelect.innerHTML = '<option value="">请选择</option>';
                // Add mock merchants for demo
                const mockMerchants = [
                    { id: 'merchant1', name: 'STARSAAS' },
                    { id: 'merchant2', name: 'Merchant 2' }
                ];
                mockMerchants.forEach(merchant => {
                    const option = document.createElement('option');
                    option.value = merchant.id;
                    option.textContent = merchant.name;
                    newMerchantSelect.appendChild(option);
                });
            }

            // Add event listener for merchant change
            newMerchantSelect.addEventListener('change', async function() {
                const merchantId = this.value;
                const subAccountSelect = document.getElementById('rr-subaccount');
                
                if (!merchantId) {
                    subAccountSelect.innerHTML = '<option value="">请选择</option>';
                    subAccountSelect.disabled = true;
                    return;
                }

                // Try to get sub-accounts from main form first
                const mainMerchantSelect = document.getElementById('merchant-name');
                const mainSubAccountSelect = document.getElementById('sub-account');
                
                if (mainMerchantSelect && mainSubAccountSelect && mainMerchantSelect.value === merchantId) {
                    // Copy from main form if same merchant is selected
                    const options = Array.from(mainSubAccountSelect.options);
                    subAccountSelect.innerHTML = '<option value="">请选择</option>';
                    options.forEach(option => {
                        if (option.value) {
                            const newOption = option.cloneNode(true);
                            subAccountSelect.appendChild(newOption);
                        }
                    });
                    subAccountSelect.disabled = false;
                } else {
                    // Load from API or use mock data
                    await loadSubAccountsForRoundRobin(merchantId);
                }
            });
        }

        // Load Sub Accounts for Round Robin
        async function loadSubAccountsForRoundRobin(merchantId) {
            const subAccountSelect = document.getElementById('rr-subaccount');
            
            // Use default sub-accounts immediately (don't wait for API)
            const defaultSubAccounts = [
                { id: 'starsaas-001', name: 'STARSAAS-001' },
                { id: 'starsaas-002', name: 'STARSAAS-002' },
                { id: 'starsaas-003', name: 'STARSAAS-003' }
            ];
            
            // Load defaults immediately
            subAccountSelect.innerHTML = '<option value="">请选择</option>';
            defaultSubAccounts.forEach(subAccount => {
                const option = document.createElement('option');
                option.value = subAccount.id;
                option.textContent = subAccount.name;
                subAccountSelect.appendChild(option);
            });
            subAccountSelect.disabled = false;
            
            // Try to load from API in background (optional)
            try {
                const response = await fetch(`/api/merchants/${merchantId}/sub-accounts`, {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.subAccounts && data.subAccounts.length > 0) {
                        subAccountSelect.innerHTML = '<option value="">请选择</option>';
                        data.subAccounts.forEach(subAccount => {
                            const option = document.createElement('option');
                            option.value = subAccount.id;
                            option.textContent = subAccount.name;
                            subAccountSelect.appendChild(option);
                        });
                        subAccountSelect.disabled = false;
                        return;
                    }
                }
            } catch (error) {
                // Silently fail - we already have default sub-accounts loaded
                console.log('Failed to load sub-accounts from API (using defaults):', error.message);
            }
            
            // Fallback already loaded above, so we're done
            const mockSubAccounts = [
                { id: 'sub1', name: 'STARSAAS' },
                { id: 'sub2', name: 'Sub Account 2' },
                { id: 'sub3', name: 'Sub Account 3' }
            ];
            mockSubAccounts.forEach(subAccount => {
                const option = document.createElement('option');
                option.value = subAccount.id;
                option.textContent = subAccount.name;
                subAccountSelect.appendChild(option);
            });
            subAccountSelect.disabled = false;
        }

        // Add Round Robin Plan Row (Show Plan Section)
        window.addRoundRobinPlanRow = function() {
            const merchant = document.getElementById('rr-merchant').value;
            const subAccount = document.getElementById('rr-subaccount').value;
            const type = document.getElementById('rr-type').value;

            if (!merchant || !subAccount || !type) {
                alert('请先填写商户号、子账号和轮询类型');
                return;
            }

            document.getElementById('rr-plan-section').style.display = 'block';
            // Show gateway settings section after plan section is shown
            document.getElementById('gateway-settings-section').style.display = 'block';
            if (document.getElementById('rr-plan-tbody').children.length === 0) {
                addRoundRobinRow();
            }
        };

        // Add Round Robin Row
        window.addRoundRobinRow = function() {
            const tbody = document.getElementById('rr-plan-tbody');
            const rowId = `rr-row-${roundRobinRowCounter++}`;
            
            // Load bound channels for this sub-account
            const merchantId = document.getElementById('rr-merchant').value;
            const subAccountId = document.getElementById('rr-subaccount').value;
            
            // Mock channels - in real implementation, load from API
            const mockChannels = [
                { id: '1', name: 'YSEPAY账号1', channel: 'YSEPAY' },
                { id: '2', name: 'RUMBLE账号1', channel: 'RUMBLE' },
                { id: '3', name: 'EVONET账号1', channel: 'EVONET' }
            ];

            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td>
                    <select class="form-select" name="rrPaymentMethod" required>
                        <option value="">请选择</option>
                        <option value="credit_card">Credit Card</option>
                        <option value="debit_card">Debit Card</option>
                        <option value="mix">混合支付</option>
                    </select>
                </td>
                <td>
                    <select class="form-select" name="rrChannel" required>
                        <option value="">请选择</option>
                        <option value="ysepay">YSEPAY</option>
                        <option value="rumble">RUMBLE</option>
                        <option value="evonet">EVONET</option>
                        <option value="paysaas">PAYSAAS</option>
                    </select>
                </td>
                <td>
                    <select class="form-select" name="rrAccountName" required>
                        <option value="">请选择</option>
                        ${mockChannels.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <select class="form-select" name="rrRowType">
                        <option value="allow" selected>允许</option>
                        <option value="specify">指定</option>
                        <option value="invalid">失效</option>
                    </select>
                </td>
                <td>
                    <select class="form-select" name="rrBackupChannel">
                        <option value="">无</option>
                        ${mockChannels.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <select class="form-select" name="rrLimitType" onchange="handleLimitTypeChange(this, '${rowId}')" style="margin-bottom: 4px;">
                            <option value="">请选择</option>
                            <option value="count">每天交易笔数(Max)</option>
                            <option value="amount">每天交易金额(Max)</option>
                        </select>
                        <input type="number" class="form-input" name="rrMaxDailyCount" min="0" placeholder="选填" style="display: none;" data-row-id="${rowId}">
                        <input type="number" class="form-input" name="rrMaxDailyAmount" min="0" step="0.01" placeholder="选填" style="display: none;" data-row-id="${rowId}">
                    </div>
                </td>
                <td>
                    <input type="text" class="form-input" name="rrRowDomain" placeholder="必填" required>
                </td>
                <td>
                    <select class="form-select" name="rrRowSendProduct">
                        <option value="no-send">无需发送</option>
                        <option value="direct-send">直接发送</option>
                        <option value="match-send">匹配发送</option>
                        <option value="replace-product">替换产品</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteRoundRobinRow('${rowId}')">删除行</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="copyRoundRobinRow('${rowId}')" style="margin-top: 4px;">复制行</button>
                </td>
            `;
            tbody.appendChild(row);
            // Update conditional fields after adding row
            updateStep7ConditionalFields();
        };

        // Handle Limit Type Change
        window.handleLimitTypeChange = function(selectElement, rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const countInput = row.querySelector('[name="rrMaxDailyCount"]');
            const amountInput = row.querySelector('[name="rrMaxDailyAmount"]');
            
            // Hide both inputs first
            if (countInput) countInput.style.display = 'none';
            if (amountInput) amountInput.style.display = 'none';
            
            // Clear values when switching
            if (countInput) countInput.value = '';
            if (amountInput) amountInput.value = '';
            
            // Show the appropriate input based on selection
            const selectedValue = selectElement.value;
            if (selectedValue === 'count' && countInput) {
                countInput.style.display = 'block';
                countInput.placeholder = '请输入每天交易笔数(Max)';
            } else if (selectedValue === 'amount' && amountInput) {
                amountInput.style.display = 'block';
                amountInput.placeholder = '请输入每天交易金额(Max)';
            }
        };

        // Delete Round Robin Row
        window.deleteRoundRobinRow = function(rowId) {
            const row = document.getElementById(rowId);
            if (row && confirm('确定要删除这一行吗？')) {
                row.remove();
                // Update conditional fields after deleting row
                updateStep7ConditionalFields();
            }
        };

        // Copy Round Robin Row
        window.copyRoundRobinRow = function(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const newRow = row.cloneNode(true);
            const newRowId = `rr-row-${roundRobinRowCounter++}`;
            newRow.id = newRowId;
            
            // Update button onclick handlers
            newRow.querySelector('button[onclick*="deleteRoundRobinRow"]').setAttribute('onclick', `deleteRoundRobinRow('${newRowId}')`);
            newRow.querySelector('button[onclick*="copyRoundRobinRow"]').setAttribute('onclick', `copyRoundRobinRow('${newRowId}')`);
            
            // Update limit type dropdown handler
            const limitTypeSelect = newRow.querySelector('[name="rrLimitType"]');
            if (limitTypeSelect) {
                limitTypeSelect.setAttribute('onchange', `handleLimitTypeChange(this, '${newRowId}')`);
            }
            
            // Update data-row-id attributes for inputs
            const countInput = newRow.querySelector('[name="rrMaxDailyCount"]');
            const amountInput = newRow.querySelector('[name="rrMaxDailyAmount"]');
            if (countInput) countInput.setAttribute('data-row-id', newRowId);
            if (amountInput) amountInput.setAttribute('data-row-id', newRowId);
            
            // Reset limit type and hide inputs
            if (limitTypeSelect) {
                limitTypeSelect.value = '';
                if (countInput) countInput.style.display = 'none';
                if (amountInput) amountInput.style.display = 'none';
            }
            
            row.parentNode.insertBefore(newRow, row.nextSibling);
        };

        // Toggle Round Robin Details
        window.toggleRoundRobinDetails = function() {
            const content = document.getElementById('rr-details-content');
            const toggle = document.getElementById('rr-details-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '▲';
            } else {
                content.style.display = 'none';
                toggle.textContent = '▼';
            }
        };

        // Toggle Gateway Settings
        window.toggleGatewaySettings = function() {
            const content = document.getElementById('gateway-settings-content');
            const toggle = document.getElementById('gateway-settings-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '▲';
            } else {
                content.style.display = 'none';
                toggle.textContent = '▼';
            }
        };

        // Update conditional fields visibility based on Step 7 requirements
        function updateStep7ConditionalFields() {
            const bindingInterfaceType = document.getElementById('rr-binding-interface-type').value;
            const restrictedCardTypesGroup = document.getElementById('rr-restricted-card-types-group');
            const channelRestrictedAddressGroup = document.getElementById('rr-channel-restricted-address-group');
            
            // Check if any plan row has payment method as Credit Card
            const planRows = document.querySelectorAll('#rr-plan-tbody tr');
            let hasCreditCardPayment = false;
            
            planRows.forEach(row => {
                const paymentMethodSelect = row.querySelector('[name="rrPaymentMethod"]');
                if (paymentMethodSelect && paymentMethodSelect.value === 'credit_card') {
                    hasCreditCardPayment = true;
                }
            });
            
            // Show conditional fields only if payment method is Credit Card (in plan rows) AND binding interface type is 2-party
            const shouldShow = hasCreditCardPayment && bindingInterfaceType === '2-party';
            
            if (shouldShow) {
                restrictedCardTypesGroup.style.display = 'block';
                channelRestrictedAddressGroup.style.display = 'block';
            } else {
                restrictedCardTypesGroup.style.display = 'none';
                channelRestrictedAddressGroup.style.display = 'none';
                // Clear values when hidden
                document.getElementById('rr-restricted-card-types').value = '';
                document.getElementById('rr-channel-restricted-address').value = '';
            }
        }
        
        // Monitor plan table for payment method changes
        function setupPlanTablePaymentMethodListeners() {
            const planTbody = document.getElementById('rr-plan-tbody');
            if (!planTbody) return;
            
            // Use event delegation to handle dynamically added rows
            planTbody.addEventListener('change', function(e) {
                if (e.target.name === 'rrPaymentMethod') {
                    updateStep7ConditionalFields();
                }
            });
        }

        // Setup event listeners for Gateway Settings
        function setupGatewaySettingsListeners() {
            const bindingInterfaceTypeSelect = document.getElementById('rr-binding-interface-type');
            
            // Add event listeners if elements exist and don't already have listeners
            if (bindingInterfaceTypeSelect && !bindingInterfaceTypeSelect.hasAttribute('data-listener-added')) {
                bindingInterfaceTypeSelect.addEventListener('change', updateStep7ConditionalFields);
                bindingInterfaceTypeSelect.setAttribute('data-listener-added', 'true');
            }
            
            // Setup listeners for plan table payment method changes
            setupPlanTablePaymentMethodListeners();
        }

        // Initialize event listeners for Step 7 conditional fields
        document.addEventListener('DOMContentLoaded', function() {
            setupGatewaySettingsListeners();
        });

        // Fill Round Robin Form
        async function fillRoundRobinForm(rr) {
            document.getElementById('rr-merchant').value = rr.merchantId || '';
            
            // Load sub-accounts for the selected merchant
            if (rr.merchantId) {
                await loadSubAccountsForRoundRobin(rr.merchantId);
                // Set sub-account value after loading
                setTimeout(() => {
                    document.getElementById('rr-subaccount').value = rr.subAccountId || '';
                }, 100);
            }
            
            document.getElementById('rr-type').value = rr.type || '';
            document.getElementById('rr-domain').value = rr.domain || '';
            document.getElementById('rr-timezone').value = rr.timezone || 'UTC+12:00';
            document.getElementById('rr-order-prefix').value = rr.orderPrefix || '';
            document.getElementById('rr-order-length').value = rr.orderLength || 12;
            document.getElementById('rr-bill-desc').value = rr.billDesc || '';
            document.getElementById('rr-domain-replace').value = rr.domainReplace || 'no';
            document.getElementById('rr-priority').value = rr.priority || 1;
            document.getElementById('rr-channel-limit-hours').value = rr.channelLimitHours || '';
            document.getElementById('rr-channel-limit-times').value = rr.channelLimitTimes || '';
            document.getElementById('rr-min-amount').value = rr.minAmount || '';
            document.getElementById('rr-max-amount').value = rr.maxAmount || '';
            document.getElementById('rr-currency').value = rr.currency || '';
            document.getElementById('rr-card-type').value = rr.cardType || '';
            document.getElementById('rr-card-bin-country').value = rr.cardBinCountry || '';
            document.getElementById('rr-match-a-domain').value = rr.matchADomain || 'no';
            document.getElementById('rr-match-address').value = rr.matchAddress || 'no';
            document.getElementById('rr-load-channel-js').value = rr.loadChannelJS || 'no';
            document.getElementById('rr-single-mid-limit').value = rr.singleMidLimit || '';

            // Fill Gateway Access Number Settings (Steps 5-7)
            if (rr.usePlatformOrder !== undefined) {
                if (rr.usePlatformOrder === 'yes') {
                    document.getElementById('rr-use-platform-order-yes').checked = true;
                } else {
                    document.getElementById('rr-use-platform-order-no').checked = true;
                }
            } else {
                document.getElementById('rr-use-platform-order-yes').checked = true;
            }
            document.getElementById('rr-merchant-domain-binding').value = rr.merchantDomainBinding || '';
            document.getElementById('rr-binding-interface-type').value = rr.bindingInterfaceType || '';
            document.getElementById('rr-restricted-card-types').value = rr.restrictedCardTypes || '';
            document.getElementById('rr-channel-restricted-address').value = rr.channelRestrictedAddress || '';
            
            // Update conditional fields visibility after a short delay to ensure DOM is ready
            setTimeout(() => {
                updateStep7ConditionalFields();
            }, 100);

            // Load plan rows
            if (rr.plans && rr.plans.length > 0) {
                document.getElementById('rr-plan-section').style.display = 'block';
                document.getElementById('gateway-settings-section').style.display = 'block';
                const tbody = document.getElementById('rr-plan-tbody');
                tbody.innerHTML = '';
                rr.plans.forEach(plan => {
                    addRoundRobinRow();
                    const lastRow = tbody.lastElementChild;
                    // Fill row data
                    if (lastRow) {
                        lastRow.querySelector('[name="rrPaymentMethod"]').value = plan.paymentMethod || '';
                        lastRow.querySelector('[name="rrChannel"]').value = plan.channel || '';
                        lastRow.querySelector('[name="rrAccountName"]').value = plan.accountName || '';
                        lastRow.querySelector('[name="rrRowType"]').value = plan.type || 'allow';
                        lastRow.querySelector('[name="rrBackupChannel"]').value = plan.backupChannel || '';
                        
                        // Handle limit type and values
                        const limitTypeSelect = lastRow.querySelector('[name="rrLimitType"]');
                        const countInput = lastRow.querySelector('[name="rrMaxDailyCount"]');
                        const amountInput = lastRow.querySelector('[name="rrMaxDailyAmount"]');
                        
                        // Determine limit type from existing data
                        let limitType = plan.limitType || '';
                        if (!limitType) {
                            // Backward compatibility: if maxDailyCount exists, use 'count', else if maxDailyAmount exists, use 'amount'
                            if (plan.maxDailyCount) {
                                limitType = 'count';
                            } else if (plan.maxDailyAmount) {
                                limitType = 'amount';
                            }
                        }
                        
                        if (limitTypeSelect && limitType) {
                            limitTypeSelect.value = limitType;
                            // Trigger the change handler to show the appropriate input
                            const rowId = lastRow.id;
                            handleLimitTypeChange(limitTypeSelect, rowId);
                            
                            // Set the value after showing the input
                            if (limitType === 'count' && countInput && plan.maxDailyCount) {
                                countInput.value = plan.maxDailyCount;
                            } else if (limitType === 'amount' && amountInput && plan.maxDailyAmount) {
                                amountInput.value = plan.maxDailyAmount;
                            }
                        }
                        
                        lastRow.querySelector('[name="rrRowDomain"]').value = plan.domain || '';
                        lastRow.querySelector('[name="rrRowSendProduct"]').value = plan.sendProduct || 'no-send';
                    }
                });
            }
        }

        // Reset Round Robin Form
        window.resetRoundRobinForm = function() {
            document.getElementById('roundrobin-form').reset();
            document.getElementById('rr-subaccount').disabled = true;
            document.getElementById('rr-plan-section').style.display = 'none';
            document.getElementById('rr-plan-tbody').innerHTML = '';
            document.getElementById('gateway-settings-section').style.display = 'none';
            document.getElementById('gateway-settings-content').style.display = 'none';
            document.getElementById('gateway-settings-toggle').textContent = '▼';
            document.getElementById('rr-details-content').style.display = 'none';
            document.getElementById('rr-details-toggle').textContent = '▼';
            // Reset Step 7 conditional fields
            document.getElementById('rr-restricted-card-types-group').style.display = 'none';
            document.getElementById('rr-channel-restricted-address-group').style.display = 'none';
            // Set default values
            document.getElementById('rr-use-platform-order-yes').checked = true;
            roundRobinRowCounter = 0;
            currentEditingRoundRobin = null;
            // Reset connection test checkbox to checked
            const performTestCheckbox = document.getElementById('performConnectionTest');
            if (performTestCheckbox) {
                performTestCheckbox.checked = true;
            }
            // Hide connection test status (if function exists)
            if (typeof hideConnectionTest === 'function') {
                hideConnectionTest();
            }
            // Hide saved connection test result
            const savedResult = document.getElementById('savedConnectionTestResult');
            if (savedResult) {
                savedResult.style.display = 'none';
            }
        };

        // Submit Round Robin Form
        window.submitRoundRobinForm = async function() {
            const form = document.getElementById('roundrobin-form');
            
            // Manual validation to avoid "not focusable" error with hidden fields
            // Check only visible required fields
            const merchant = document.getElementById('rr-merchant')?.value;
            const subAccount = document.getElementById('rr-subaccount')?.value;
            const type = document.getElementById('rr-type')?.value;
            
            if (!merchant || !subAccount || !type) {
                alert('请填写商户号、子账号和轮询类型');
                return;
            }
            
            // Validate plan rows
            const planRows = document.querySelectorAll('#rr-plan-tbody tr');
            if (planRows.length === 0) {
                alert('请至少添加一条轮循计划');
                return;
            }
            
            // Validate each plan row - check domain in each row
            let hasInvalidRow = false;
            planRows.forEach((row, index) => {
                const domain = row.querySelector('[name="rrRowDomain"]')?.value;
                const paymentMethod = row.querySelector('[name="rrPaymentMethod"]')?.value;
                const channel = row.querySelector('[name="rrChannel"]')?.value;
                const accountName = row.querySelector('[name="rrAccountName"]')?.value;
                
                if (!domain || domain.trim() === '' || !paymentMethod || !channel || !accountName) {
                    hasInvalidRow = true;
                    if (!domain || domain.trim() === '') {
                        alert(`第 ${index + 1} 行的域名字段为必填项`);
                    } else {
                        alert(`第 ${index + 1} 行请填写完整的计划信息`);
                    }
                }
            });
            
            if (hasInvalidRow) {
                return;
            }

            // Collect form data
            const plans = Array.from(planRows).map(row => {
                const paymentMethod = row.querySelector('[name="rrPaymentMethod"]').value;
                const channel = row.querySelector('[name="rrChannel"]').value;
                const accountName = row.querySelector('[name="rrAccountName"]').value;
                const domain = row.querySelector('[name="rrRowDomain"]').value;
                
                if (!paymentMethod || !channel || !accountName || !domain) {
                    return null;
                }

                const limitType = row.querySelector('[name="rrLimitType"]').value;
                const maxDailyCount = limitType === 'count' ? row.querySelector('[name="rrMaxDailyCount"]').value : '';
                const maxDailyAmount = limitType === 'amount' ? row.querySelector('[name="rrMaxDailyAmount"]').value : '';

                return {
                    paymentMethod,
                    channel,
                    accountName,
                    type: row.querySelector('[name="rrRowType"]').value,
                    backupChannel: row.querySelector('[name="rrBackupChannel"]').value,
                    limitType: limitType,
                    maxDailyCount: maxDailyCount,
                    maxDailyAmount: maxDailyAmount,
                    domain: row.querySelector('[name="rrRowDomain"]').value
                };
            }).filter(p => p !== null);

            if (plans.length === 0) {
                alert('请至少填写一条完整的轮循计划');
                return;
            }

            const formData = {
                id: currentEditingRoundRobin ? currentEditingRoundRobin.id : Date.now(),
                merchantId: document.getElementById('rr-merchant').value,
                subAccountId: document.getElementById('rr-subaccount').value,
                type: document.getElementById('rr-type').value,
                domain: document.getElementById('rr-domain').value,
                timezone: document.getElementById('rr-timezone').value,
                orderPrefix: document.getElementById('rr-order-prefix').value,
                orderLength: parseInt(document.getElementById('rr-order-length').value) || 12,
                billDesc: document.getElementById('rr-bill-desc').value,
                domainReplace: document.getElementById('rr-domain-replace').value,
                priority: parseInt(document.getElementById('rr-priority').value) || 1,
                channelLimitHours: document.getElementById('rr-channel-limit-hours').value,
                channelLimitTimes: document.getElementById('rr-channel-limit-times').value,
                minAmount: document.getElementById('rr-min-amount').value,
                maxAmount: document.getElementById('rr-max-amount').value,
                currency: document.getElementById('rr-currency').value,
                cardType: document.getElementById('rr-card-type').value,
                cardBinCountry: document.getElementById('rr-card-bin-country').value,
                matchADomain: document.getElementById('rr-match-a-domain').value,
                matchAddress: document.getElementById('rr-match-address').value,
                loadChannelJS: document.getElementById('rr-load-channel-js').value,
                singleMidLimit: document.getElementById('rr-single-mid-limit').value,
                // Gateway Access Number Settings (Steps 5-7)
                usePlatformOrder: document.querySelector('input[name="rrUsePlatformOrder"]:checked')?.value || 'yes',
                merchantDomainBinding: document.getElementById('rr-merchant-domain-binding').value,
                bindingInterfaceType: document.getElementById('rr-binding-interface-type').value,
                restrictedCardTypes: document.getElementById('rr-restricted-card-types').value,
                channelRestrictedAddress: document.getElementById('rr-channel-restricted-address').value,
                plans: plans
            };

            try {
                const response = await fetch('/api/round-robin/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    // Check if connection test should be performed
                    const performTest = document.getElementById('performConnectionTest')?.checked ?? true;
                    
                    if (performTest) {
                        // Show connection test after successful save
                        console.log('[Round Robin] Save successful, performing connection test');
                        
                        // Show connection test immediately
                        if (typeof window.showConnectionTest === 'function') {
                            window.showConnectionTest();
                            console.log('[Round Robin] Connection test status shown');
                        } else {
                            console.warn('[Round Robin] showConnectionTest function not available');
                        }
                        
                        // Run connection test animation
                        let testResult = 'failed';
                        if (typeof window.mockConnectionTest === 'function') {
                            try {
                                await window.mockConnectionTest();
                                testResult = 'success';
                                console.log('[Round Robin] Connection test completed successfully');
                            } catch (error) {
                                testResult = 'failed';
                                console.error('[Round Robin] Connection test failed:', error);
                            }
                        } else {
                            console.warn('[Round Robin] mockConnectionTest function not available');
                        }
                        
                        // Save connection test result
                        saveConnectionTestResult(testResult);
                        
                        // Wait a bit for user to see the success message
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } else {
                        console.log('[Round Robin] Connection test skipped (checkbox unchecked)');
                    }
                    
                    // Refresh the list but keep modal open
                    loadRoundRobinList();
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Save round robin error:', error);
                // Fallback: save to localStorage
                if (currentEditingRoundRobin) {
                    const index = roundRobinData.findIndex(r => r.id === currentEditingRoundRobin.id);
                    if (index >= 0) {
                        roundRobinData[index] = formData;
                    }
                } else {
                    roundRobinData.push(formData);
                }
                localStorage.setItem('roundRobinList', JSON.stringify(roundRobinData));
                
                // Check if connection test should be performed
                const performTest = document.getElementById('performConnectionTest')?.checked ?? true;
                
                if (performTest) {
                    // Show connection test even in fallback mode
                    console.log('[Round Robin] Save to localStorage, performing connection test');
                    
                    // Show connection test immediately
                    if (typeof window.showConnectionTest === 'function') {
                        window.showConnectionTest();
                        console.log('[Round Robin] Connection test status shown (localStorage)');
                    } else {
                        console.warn('[Round Robin] showConnectionTest function not available');
                    }
                    
                    // Run connection test animation
                    let testResult = 'failed';
                    if (typeof window.mockConnectionTest === 'function') {
                        try {
                            await window.mockConnectionTest();
                            testResult = 'success';
                            console.log('[Round Robin] Connection test completed (localStorage)');
                        } catch (error) {
                            testResult = 'failed';
                            console.error('[Round Robin] Connection test failed:', error);
                        }
                    } else {
                        console.warn('[Round Robin] mockConnectionTest function not available');
                    }
                    
                    // Save connection test result
                    saveConnectionTestResult(testResult);
                    
                    // Wait a bit for user to see the success message
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } else {
                    console.log('[Round Robin] Connection test skipped (checkbox unchecked)');
                }
                
                // Refresh the list but keep modal open
                loadRoundRobinList();
            }
        };

        // Save Connection Test Result
        window.saveConnectionTestResult = function(result) {
            const testDate = new Date();
            const testData = {
                date: testDate.toISOString(),
                dateTime: testDate.toLocaleString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                }),
                result: result, // 'success' or 'failed'
                timestamp: testDate.getTime()
            };
            
            // Save to localStorage (keyed by form data ID if available)
            const formId = currentEditingRoundRobin?.id || 'latest';
            localStorage.setItem(`roundRobinConnectionTest_${formId}`, JSON.stringify(testData));
            
            // Also save as latest
            localStorage.setItem('roundRobinConnectionTest_latest', JSON.stringify(testData));
            
            // Display the saved result
            displaySavedConnectionTestResult(testData);
            
            console.log('[Round Robin] Connection test result saved:', testData);
        };
        
        // Display Saved Connection Test Result
        window.displaySavedConnectionTestResult = function(testData) {
            const resultContainer = document.getElementById('savedConnectionTestResult');
            const dateEl = document.getElementById('savedTestDate');
            const statusEl = document.getElementById('savedTestStatus');
            
            console.log('[Round Robin] Displaying saved connection test result:', testData);
            
            if (resultContainer && dateEl && statusEl && testData) {
                // Format date/time
                let displayDate = testData.dateTime;
                if (!displayDate && testData.date) {
                    try {
                        const date = new Date(testData.date);
                        displayDate = date.toLocaleString('zh-CN', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit' 
                        });
                    } catch (e) {
                        displayDate = testData.date;
                    }
                }
                
                dateEl.textContent = displayDate || '未知';
                statusEl.textContent = testData.result === 'success' ? '成功' : '失败';
                statusEl.className = 'saved-result-status ' + (testData.result === 'success' ? 'success' : 'failed');
                resultContainer.style.display = 'block';
                
                // Scroll into view
                setTimeout(() => {
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                console.warn('[Round Robin] Missing elements for displaying saved result:', {
                    resultContainer: !!resultContainer,
                    dateEl: !!dateEl,
                    statusEl: !!statusEl,
                    testData: !!testData
                });
            }
        };
        
        // Load Saved Connection Test Result
        window.loadSavedConnectionTestResult = function() {
            const formId = currentEditingRoundRobin?.id || 'latest';
            const saved = localStorage.getItem(`roundRobinConnectionTest_${formId}`) || 
                         localStorage.getItem('roundRobinConnectionTest_latest');
            
            if (saved) {
                try {
                    const testData = JSON.parse(saved);
                    displaySavedConnectionTestResult(testData);
                } catch (e) {
                    console.warn('Failed to parse saved connection test result:', e);
                }
            }
        };

        // Close Round Robin Modal
        window.closeRoundRobinModal = function() {
            document.getElementById('roundrobin-modal').style.display = 'none';
            resetRoundRobinForm();
            // Hide connection test status (if function exists)
            if (typeof hideConnectionTest === 'function') {
                hideConnectionTest();
            }
        };

        // Delete Round Robin
        window.deleteRoundRobin = function(id) {
            if (!confirm('确定要删除这条轮循配置吗？')) return;
            
            roundRobinData = roundRobinData.filter(r => (r.id || roundRobinData.indexOf(r)) !== id);
            localStorage.setItem('roundRobinList', JSON.stringify(roundRobinData));
            loadRoundRobinList();
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal when clicking outside
            document.getElementById('roundrobin-modal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRoundRobinModal();
                }
            });
            
            // Close rejection modal when clicking outside
            document.getElementById('rejectionDetailsModal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRejectionModal();
                }
            });
        });
    </script>
    <script>
        // Configure Foundry chat agent for this page (渠道绑定配置)
        // Define available agents
        window.FOUNDRY_AVAILABLE_AGENTS = {
            'self-onboarding': {
                endpoint: 'https://starcsagent-resource.services.ai.azure.com/api/projects/starcsagent/applications/starselfonboarding/protocols/openai/responses?api-version=2025-11-15-preview',
                agentName: 'Chloe',
                agentTitle: 'STAR SAAS 自助开通助手',
                agentModel: 'Self-Onboarding Agent',
                agentAvatar: 'chloe.jpg'
            },
            'cs': {
                endpoint: 'https://starcsagent-resource.services.ai.azure.com/api/projects/starcsagent/applications/starsaascs/protocols/openai/responses?api-version=2025-11-15-preview',
                agentName: 'AI 助手',
                agentTitle: 'STAR SAAS 客户服务',
                agentModel: 'CS Agent',
                agentAvatar: '👩‍💼'
            },
            'configurator': {
                endpoint: 'https://starcsagent-resource.services.ai.azure.com/api/projects/starcsagent/applications/starconfigurator/protocols/openai/responses?api-version=2025-11-15-preview',
                agentName: '配置助手',
                agentTitle: 'STAR SAAS 配置助手',
                agentModel: 'Configuration Agent',
                agentAvatar: '⚙️',
                canInteractWithPage: true // Enable page interaction
            }
        };
        
        // Set default agent
        window.FOUNDRY_CHAT_CONFIG = {
            ...window.FOUNDRY_AVAILABLE_AGENTS['self-onboarding'],
            useProxy: true,
            proxyEndpoint: 'http://localhost:3001/api/chat',
            defaultAgent: 'self-onboarding'
        };
    </script>
    <script src="foundry-chat.js"></script>
    
    <script>
        // Analysis Tab JavaScript
        let analysisData = {
            'last-week': null,
            'last-month': null,
            'all-time': null
        };

        // Initialize analysis filters
        function initAnalysisFilters() {
            // Load merchant options
            const merchantSelect = document.getElementById('analysisMerchantSelect');
            if (merchantSelect && merchantSelect.options.length === 1) {
                const merchants = ['STARSAAS', 'NbcPay', 'NexPay'];
                merchants.forEach(merchant => {
                    const option = document.createElement('option');
                    option.value = merchant.toLowerCase();
                    option.textContent = merchant;
                    merchantSelect.appendChild(option);
                });
                
                // Add event listener for merchant change
                merchantSelect.addEventListener('change', function() {
                    updateSubMerchantOptions();
                    loadAnalysisData();
                });
            }

            // Load sub-merchant options (depends on selected merchant)
            updateSubMerchantOptions();
        }

        // Update sub-merchant options based on selected merchant
        function updateSubMerchantOptions() {
            const merchantSelect = document.getElementById('analysisMerchantSelect');
            const subMerchantSelect = document.getElementById('analysisSubMerchantSelect');
            const selectedMerchant = merchantSelect ? merchantSelect.value : '';

            if (subMerchantSelect) {
                // Clear existing options except "全部子商户"
                while (subMerchantSelect.options.length > 1) {
                    subMerchantSelect.remove(1);
                }

                // Add sub-merchants based on selected merchant
                const subMerchants = {
                    'starsaas': ['Sub-Account-001', 'Sub-Account-002', 'Sub-Account-003'],
                    'nbcpay': ['NBC-Sub-001', 'NBC-Sub-002'],
                    'nexpay': ['Nex-Sub-001', 'Nex-Sub-002', 'Nex-Sub-003', 'Nex-Sub-004']
                };

                if (selectedMerchant && subMerchants[selectedMerchant]) {
                    subMerchants[selectedMerchant].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subMerchantSelect.appendChild(option);
                    });
                } else if (!selectedMerchant) {
                    // Show all sub-merchants when no merchant selected
                    Object.values(subMerchants).flat().forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subMerchantSelect.appendChild(option);
                    });
                }
            }
        }

        // Track selected channel for filtering rejection reasons
        let selectedChannelForDetails = null;

        // Reset analysis filters
        window.resetAnalysisFilters = function() {
            document.getElementById('timePeriodSelect').value = 'last-month';
            document.getElementById('analysisMerchantSelect').value = '';
            document.getElementById('analysisSubMerchantSelect').value = '';
            document.getElementById('analysisChannelSelect').value = '';
            document.getElementById('analysisPlatformSelect').value = '';
            selectedChannelForDetails = null;
            // Hide the rejection reasons section when filters are reset
            const reasonsSection = document.getElementById('rejectionReasonsSection');
            if (reasonsSection) {
                reasonsSection.style.display = 'none';
            }
            updateSubMerchantOptions();
            loadAnalysisData();
        };
        
        // Show details for a specific channel
        window.showChannelDetails = function(channelName) {
            console.log('[Analysis] showChannelDetails called for channel:', channelName);
            selectedChannelForDetails = channelName;
            
            // Show the rejection reasons section
            const reasonsSection = document.getElementById('rejectionReasonsSection');
            if (reasonsSection) {
                // Force show the section
                reasonsSection.style.display = 'block';
                reasonsSection.style.visibility = 'visible';
                reasonsSection.style.opacity = '1';
                // Force a reflow to ensure display change is applied
                void reasonsSection.offsetHeight;
                console.log('[Analysis] Section display set to block, computed style:', window.getComputedStyle(reasonsSection).display);
            } else {
                console.error('[Analysis] rejectionReasonsSection element not found');
            }
            
            // Reload analysis data to show filtered rejection reasons
            loadAnalysisData();
            
            // Scroll to rejection reasons section after data loads
            setTimeout(() => {
                const reasonsTable = document.getElementById('rejectionReasonsTable');
                if (reasonsTable) {
                    reasonsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 600); // Wait a bit longer for data to load
        };

        // Load analysis data
        window.loadAnalysisData = function() {
            const timePeriod = document.getElementById('timePeriodSelect').value;
            const merchant = document.getElementById('analysisMerchantSelect').value;
            const subMerchant = document.getElementById('analysisSubMerchantSelect').value;
            const channel = document.getElementById('analysisChannelSelect').value;
            const platform = document.getElementById('analysisPlatformSelect').value;
            
            // Show loading
            document.getElementById('transactionStatsBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">加载中...</td></tr>';
            // Only show loading in rejection reasons if section is visible
            const reasonsSection = document.getElementById('rejectionReasonsSection');
            if (reasonsSection && reasonsSection.style.display !== 'none') {
                document.getElementById('rejectionReasonsBody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">加载中...</td></tr>';
            }
            
            // Mock data - in production, this would fetch from API with filters
            setTimeout(() => {
                const data = getMockAnalysisData(timePeriod, { merchant, subMerchant, channel, platform });
                displayAnalysisData(data);
            }, 500);
        };

        // Get channel-specific rejection reasons
        function getChannelRejectionReasons(channelName, timePeriod) {
            // Base rejection reasons data per channel
            const channelReasons = {
                'YSEPAY': {
                    'last-week': [
                        { reason: '余额不足', count: 8, percentage: 53.3 },
                        { reason: '卡号无效', count: 4, percentage: 26.7 },
                        { reason: '交易超时', count: 2, percentage: 13.3 },
                        { reason: '风险控制拒绝', count: 1, percentage: 6.7 }
                    ],
                    'last-month': [
                        { reason: '余额不足', count: 32, percentage: 53.3 },
                        { reason: '卡号无效', count: 16, percentage: 26.7 },
                        { reason: '交易超时', count: 8, percentage: 13.3 },
                        { reason: '风险控制拒绝', count: 4, percentage: 6.7 }
                    ],
                    'all-time': [
                        { reason: '余额不足', count: 160, percentage: 53.3 },
                        { reason: '卡号无效', count: 80, percentage: 26.7 },
                        { reason: '交易超时', count: 40, percentage: 13.3 },
                        { reason: '风险控制拒绝', count: 20, percentage: 6.7 }
                    ]
                },
                'RUMBLE': {
                    'last-week': [
                        { reason: '卡号无效', count: 10, percentage: 55.6 },
                        { reason: '余额不足', count: 5, percentage: 27.8 },
                        { reason: '交易超时', count: 2, percentage: 11.1 },
                        { reason: '渠道维护', count: 1, percentage: 5.6 }
                    ],
                    'last-month': [
                        { reason: '卡号无效', count: 44, percentage: 55.0 },
                        { reason: '余额不足', count: 22, percentage: 27.5 },
                        { reason: '交易超时', count: 9, percentage: 11.3 },
                        { reason: '渠道维护', count: 5, percentage: 6.3 }
                    ],
                    'all-time': [
                        { reason: '卡号无效', count: 182, percentage: 55.2 },
                        { reason: '余额不足', count: 91, percentage: 27.6 },
                        { reason: '交易超时', count: 37, percentage: 11.2 },
                        { reason: '渠道维护', count: 20, percentage: 6.1 }
                    ]
                },
                'EVONET': {
                    'last-week': [
                        { reason: '交易超时', count: 6, percentage: 60.0 },
                        { reason: '余额不足', count: 2, percentage: 20.0 },
                        { reason: '平台超时', count: 1, percentage: 10.0 },
                        { reason: '平台接口异常', count: 1, percentage: 10.0 }
                    ],
                    'last-month': [
                        { reason: '交易超时', count: 21, percentage: 60.0 },
                        { reason: '余额不足', count: 7, percentage: 20.0 },
                        { reason: '平台超时', count: 4, percentage: 11.4 },
                        { reason: '平台接口异常', count: 3, percentage: 8.6 }
                    ],
                    'all-time': [
                        { reason: '交易超时', count: 96, percentage: 60.0 },
                        { reason: '余额不足', count: 32, percentage: 20.0 },
                        { reason: '平台超时', count: 18, percentage: 11.3 },
                        { reason: '平台接口异常', count: 14, percentage: 8.8 }
                    ]
                },
                'PAYSAAS': {
                    'last-week': [
                        { reason: '无效币种配置', count: 15, percentage: 55.6 },
                        { reason: '渠道不支持该币种', count: 8, percentage: 29.6 },
                        { reason: '平台币种不支持', count: 3, percentage: 11.1 },
                        { reason: '平台加密错误', count: 1, percentage: 3.7 }
                    ],
                    'last-month': [
                        { reason: '无效币种配置', count: 47, percentage: 55.3 },
                        { reason: '渠道不支持该币种', count: 25, percentage: 29.4 },
                        { reason: '平台币种不支持', count: 10, percentage: 11.8 },
                        { reason: '平台加密错误', count: 3, percentage: 3.5 }
                    ],
                    'all-time': [
                        { reason: '无效币种配置', count: 200, percentage: 55.6 },
                        { reason: '渠道不支持该币种', count: 106, percentage: 29.4 },
                        { reason: '平台币种不支持', count: 42, percentage: 11.7 },
                        { reason: '平台加密错误', count: 12, percentage: 3.3 }
                    ]
                }
            };
            
            const channelData = channelReasons[channelName];
            if (!channelData) {
                return [];
            }
            
            return channelData[timePeriod] || channelData['last-month'] || [];
        }

        // Get mock analysis data (make it globally accessible)
        window.getMockAnalysisData = function(timePeriod, filters = {}) {
            const { merchant, subMerchant, channel, platform } = filters;
            // Filter data based on selected filters
            // Generate different data based on filters to make it more realistic
            let baseData = {
                'last-week': {
                    totalTransactions: 1250,
                    approved: 1100,
                    failed: 80,
                    rejected: 70,
                    byChannel: [
                        { channel: 'YSEPAY', total: 450, success: 410, failed: 25, rejected: 15, successRate: 91.1 },
                        { channel: 'RUMBLE', total: 380, success: 340, failed: 22, rejected: 18, successRate: 89.5 },
                        { channel: 'EVONET', total: 280, success: 250, failed: 20, rejected: 10, successRate: 89.3 },
                        { channel: 'PAYSAAS', total: 140, success: 100, failed: 13, rejected: 27, successRate: 71.4 }
                    ],
                    rejectionReasons: [
                        { reason: '余额不足', count: 25, percentage: 35.7 },
                        { reason: '卡号无效', count: 18, percentage: 25.7 },
                        { reason: '交易超时', count: 12, percentage: 17.1 },
                        { reason: '风险控制拒绝', count: 10, percentage: 14.3 },
                        { reason: '无效币种配置', count: 8, percentage: 11.4 },
                        { reason: '渠道不支持该币种', count: 5, percentage: 7.1 },
                        { reason: '平台超时', count: 4, percentage: 5.7 },
                        { reason: '平台币种不支持', count: 3, percentage: 4.3 },
                        { reason: '平台加密错误', count: 2, percentage: 2.9 },
                        { reason: '其他', count: 1, percentage: 1.4 }
                    ]
                },
                'last-month': {
                    totalTransactions: 5420,
                    approved: 4780,
                    failed: 380,
                    rejected: 260,
                    byChannel: [
                        { channel: 'YSEPAY', total: 1950, success: 1780, failed: 110, rejected: 60, successRate: 91.3 },
                        { channel: 'RUMBLE', total: 1680, success: 1500, failed: 100, rejected: 80, successRate: 89.3 },
                        { channel: 'EVONET', total: 1200, success: 1080, failed: 85, rejected: 35, successRate: 90.0 },
                        { channel: 'PAYSAAS', total: 590, success: 420, failed: 85, rejected: 85, successRate: 71.2 }
                    ],
                    rejectionReasons: [
                        { reason: '余额不足', count: 95, percentage: 36.5 },
                        { reason: '卡号无效', count: 68, percentage: 26.2 },
                        { reason: '交易超时', count: 45, percentage: 17.3 },
                        { reason: '风险控制拒绝', count: 38, percentage: 14.6 },
                        { reason: '无效币种配置', count: 28, percentage: 10.8 },
                        { reason: '渠道不支持该币种', count: 18, percentage: 6.9 },
                        { reason: '平台超时', count: 15, percentage: 5.8 },
                        { reason: '平台币种不支持', count: 12, percentage: 4.6 },
                        { reason: '平台加密错误', count: 10, percentage: 3.8 },
                        { reason: '平台接口异常', count: 8, percentage: 3.1 },
                        { reason: '渠道维护', count: 8, percentage: 3.1 },
                        { reason: '其他', count: 6, percentage: 2.3 }
                    ]
                },
                'all-time': {
                    totalTransactions: 28450,
                    approved: 25120,
                    failed: 2180,
                    rejected: 1150,
                    byChannel: [
                        { channel: 'YSEPAY', total: 10200, success: 9320, failed: 580, rejected: 300, successRate: 91.4 },
                        { channel: 'RUMBLE', total: 8800, success: 7850, failed: 620, rejected: 330, successRate: 89.2 },
                        { channel: 'EVONET', total: 6400, success: 5760, failed: 480, rejected: 160, successRate: 90.0 },
                        { channel: 'PAYSAAS', total: 3050, success: 2190, failed: 500, rejected: 360, successRate: 71.8 }
                    ],
                    rejectionReasons: [
                        { reason: '余额不足', count: 420, percentage: 36.5 },
                        { reason: '卡号无效', count: 300, percentage: 26.1 },
                        { reason: '交易超时', count: 200, percentage: 17.4 },
                        { reason: '风险控制拒绝', count: 165, percentage: 14.3 },
                        { reason: '无效币种配置', count: 125, percentage: 10.9 },
                        { reason: '渠道不支持该币种', count: 85, percentage: 7.4 },
                        { reason: '平台超时', count: 65, percentage: 5.7 },
                        { reason: '平台币种不支持', count: 52, percentage: 4.5 },
                        { reason: '平台加密错误', count: 42, percentage: 3.7 },
                        { reason: '平台接口异常', count: 35, percentage: 3.0 },
                        { reason: '平台签名验证失败', count: 28, percentage: 2.4 },
                        { reason: '渠道维护', count: 45, percentage: 3.9 },
                        { reason: '其他', count: 20, percentage: 1.7 }
                    ]
                }
            };
            
            // Get base data for the selected time period
            let data = JSON.parse(JSON.stringify(baseData[timePeriod] || baseData['last-month']));
            
            // Apply channel filter
            if (channel) {
                const channelUpper = channel.toUpperCase();
                const channelData = data.byChannel.find(c => c.channel === channelUpper);
                if (channelData) {
                    data.byChannel = [channelData];
                    data.totalTransactions = channelData.total;
                    data.approved = channelData.success;
                    data.failed = channelData.failed;
                    data.rejected = channelData.rejected;
                } else {
                    // If channel not found, show empty data
                    data.byChannel = [];
                    data.totalTransactions = 0;
                    data.approved = 0;
                    data.failed = 0;
                    data.rejected = 0;
                }
            }
            
            // Apply merchant/sub-merchant/platform filters (simulate filtered data)
            if (merchant || subMerchant || platform) {
                const filterMultiplier = 0.65 + Math.random() * 0.25; // Random between 65-90%
                data.totalTransactions = Math.round(data.totalTransactions * filterMultiplier);
                data.approved = Math.round(data.approved * filterMultiplier);
                data.failed = Math.round(data.failed * filterMultiplier);
                data.rejected = Math.round(data.rejected * filterMultiplier);
                
                // Update channel data proportionally
                data.byChannel = data.byChannel.map(c => {
                    const mult = filterMultiplier + (Math.random() * 0.1 - 0.05); // Slight variation
                    const newTotal = Math.round(c.total * mult);
                    const newSuccess = Math.round(c.success * mult);
                    const newFailed = Math.round(c.failed * mult);
                    const newRejected = Math.round(c.rejected * mult);
                    const successRate = newTotal > 0 ? parseFloat(((newSuccess / newTotal) * 100).toFixed(1)) : 0;
                    return {
                        channel: c.channel,
                        total: newTotal,
                        success: newSuccess,
                        failed: newFailed,
                        rejected: newRejected,
                        successRate: successRate
                    };
                });
                
                    // Update rejection reasons proportionally
                    data.rejectionReasons = data.rejectionReasons.map(r => {
                        const newCount = Math.max(1, Math.round(r.count * filterMultiplier)); // At least 1 if original had count
                        return {
                            reason: r.reason,
                            count: newCount,
                            percentage: 0 // Will be recalculated in display function
                        };
                    });
            }
            
            // Ensure all values are valid numbers (safety check)
            data.totalTransactions = data.totalTransactions || 0;
            data.approved = data.approved || 0;
            data.failed = data.failed || 0;
            data.rejected = data.rejected || 0;
            
            // Ensure byChannel array exists
            if (!data.byChannel || data.byChannel.length === 0) {
                // If no channel filter, show all channels with 0 data
                if (!channel) {
                    data.byChannel = [
                        { channel: 'YSEPAY', total: 0, success: 0, failed: 0, rejected: 0, successRate: 0 },
                        { channel: 'RUMBLE', total: 0, success: 0, failed: 0, rejected: 0, successRate: 0 },
                        { channel: 'EVONET', total: 0, success: 0, failed: 0, rejected: 0, successRate: 0 },
                        { channel: 'PAYSAAS', total: 0, success: 0, failed: 0, rejected: 0, successRate: 0 }
                    ];
                }
            }
            
            // Ensure rejectionReasons array exists
            if (!data.rejectionReasons || data.rejectionReasons.length === 0) {
                data.rejectionReasons = [];
            }
            
            return data;
        };

        // Display analysis data
        function displayAnalysisData(data) {
            // Update summary cards
            const total = data.totalTransactions || 0;
            const approved = data.approved || 0;
            const failed = data.failed || 0;
            const rejected = data.rejected || 0;
            
            document.getElementById('totalTransactions').textContent = total.toLocaleString();
            
            // Calculate approval rate safely
            let approvalRate = 0;
            if (total > 0) {
                approvalRate = ((approved / total) * 100).toFixed(1);
            }
            document.getElementById('approvalRate').textContent = approvalRate + '%';
            document.getElementById('failedTransactions').textContent = failed.toLocaleString();
            document.getElementById('rejectedTransactions').textContent = rejected.toLocaleString();

            // Update transaction statistics table
            const statsBody = document.getElementById('transactionStatsBody');
            if (!data.byChannel || data.byChannel.length === 0) {
                statsBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">暂无数据</td></tr>';
            } else {
                // Filter out channels with 0 transactions if needed, or show all
                const channelsToShow = data.byChannel.filter(c => c.total > 0);
                if (channelsToShow.length === 0) {
                    statsBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">暂无数据</td></tr>';
                } else {
                    statsBody.innerHTML = channelsToShow.map(channel => {
                        const total = channel.total || 0;
                        const success = channel.success || 0;
                        const failed = channel.failed || 0;
                        const rejected = channel.rejected || 0;
                        const successRate = total > 0 ? ((success / total) * 100).toFixed(1) : '0.0';
                        const isSelected = selectedChannelForDetails === channel.channel;
                        return `
                            <tr ${isSelected ? 'style="background-color: #f0f8ff;"' : ''}>
                                <td>${channel.channel}</td>
                                <td>${total.toLocaleString()}</td>
                                <td style="color: #28a745;">${success.toLocaleString()}</td>
                                <td style="color: #ff9800;">${failed.toLocaleString()}</td>
                                <td style="color: #dc3545;">${rejected.toLocaleString()}</td>
                                <td><strong>${successRate}%</strong></td>
                                <td>
                                    <a href="javascript:void(0);" 
                                       onclick="showChannelDetails('${channel.channel}')" 
                                       style="color: #4A90E2; text-decoration: none; cursor: pointer; font-weight: 500;">
                                        ${isSelected ? '✓ 已选择' : '详细'}
                                    </a>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // Update rejection reasons table - filter by selected channel if any
            // Only update if section is visible (i.e., a channel detail was selected)
            const reasonsSection = document.getElementById('rejectionReasonsSection');
            // Check if section should be visible (either explicitly set to block or if a channel is selected)
            const shouldShowSection = selectedChannelForDetails !== null;
            const isSectionVisible = reasonsSection && shouldShowSection;
            
            if (isSectionVisible) {
                // Ensure section is visible
                if (reasonsSection.style.display === 'none') {
                    reasonsSection.style.display = 'block';
                }
                const reasonsBody = document.getElementById('rejectionReasonsBody');
                let reasonsToDisplay = [];
                
                if (selectedChannelForDetails) {
                    // Show channel-specific rejection reasons
                    const timePeriod = document.getElementById('timePeriodSelect').value;
                    reasonsToDisplay = getChannelRejectionReasons(selectedChannelForDetails, timePeriod);
                } else {
                    // Show all rejection reasons (aggregate)
                    reasonsToDisplay = data.rejectionReasons || [];
                }
                
                if (!reasonsToDisplay || reasonsToDisplay.length === 0) {
                    const noDataMessage = selectedChannelForDetails 
                        ? `暂无 ${selectedChannelForDetails} 渠道的失败/拒绝原因数据`
                        : '暂无数据';
                    reasonsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">${noDataMessage}</td></tr>`;
                } else {
                    // Filter out reasons with 0 count
                    const reasonsToShow = reasonsToDisplay.filter(r => r.count > 0);
                    if (reasonsToShow.length === 0) {
                        const noDataMessage = selectedChannelForDetails 
                            ? `暂无 ${selectedChannelForDetails} 渠道的失败/拒绝原因数据`
                            : '暂无数据';
                        reasonsBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">${noDataMessage}</td></tr>`;
                    } else {
                        // Recalculate percentages based on total rejected
                        const totalRejected = reasonsToShow.reduce((sum, r) => sum + (r.count || 0), 0);
                        reasonsBody.innerHTML = reasonsToShow.map((reason, index) => {
                            const count = reason.count || 0;
                            const percentage = totalRejected > 0 ? ((count / totalRejected) * 100).toFixed(1) : '0.0';
                            const reasonKey = reason.reason;
                            return `
                                <tr>
                                    <td>${reason.reason}</td>
                                    <td>${count.toLocaleString()}</td>
                                    <td><strong>${percentage}%</strong></td>
                                    <td>
                                        <a href="#" class="rejection-detail-link" onclick="showRejectionDetails('${reasonKey}', ${count}); return false;">
                                            查看详情
                                        </a>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Update section title to show selected channel if any
                const sectionTitle = document.querySelector('#rejectionReasonsTable').closest('.analysis-section')?.querySelector('.section-title');
                if (sectionTitle) {
                    if (selectedChannelForDetails) {
                        sectionTitle.textContent = `失败/拒绝原因分析 - ${selectedChannelForDetails}`;
                    } else {
                        sectionTitle.textContent = '失败/拒绝原因分析';
                    }
                }
            }
        }

        // Show rejection details modal
        window.showRejectionDetails = function(reason, count) {
            const modal = document.getElementById('rejectionDetailsModal');
            const modalTitle = document.getElementById('rejectionModalTitle');
            const detailReason = document.getElementById('rejectionDetailReason');
            const detailBankResponse = document.getElementById('rejectionDetailBankResponse');
            const detailCode = document.getElementById('rejectionDetailCode');
            const detailTransactions = document.getElementById('rejectionDetailTransactions');

            // Get detailed information for this rejection reason
            const details = getRejectionDetails(reason, count);

            modalTitle.textContent = `拒绝详情 - ${reason}`;
            detailReason.textContent = reason;
            detailCode.textContent = details.responseCode || 'N/A';
            
            // Format bank response as JSON
            detailBankResponse.innerHTML = `<pre>${JSON.stringify(details.bankResponse, null, 2)}</pre>`;
            
            // Show sample transactions
            detailTransactions.innerHTML = details.sampleTransactions.map(txn => `
                <div class="rejection-transaction-item">
                    <div class="transaction-row">
                        <span class="transaction-label">交易ID:</span>
                        <span class="transaction-value">${txn.transactionId}</span>
                    </div>
                    <div class="transaction-row">
                        <span class="transaction-label">时间:</span>
                        <span class="transaction-value">${txn.timestamp}</span>
                    </div>
                    <div class="transaction-row">
                        <span class="transaction-label">金额:</span>
                        <span class="transaction-value">${txn.amount}</span>
                    </div>
                    <div class="transaction-row">
                        <span class="transaction-label">渠道:</span>
                        <span class="transaction-value">${txn.channel}</span>
                    </div>
                    <div class="transaction-row">
                        <span class="transaction-label">响应:</span>
                        <span class="transaction-value" style="color: #dc3545;">${txn.response}</span>
                    </div>
                </div>
            `).join('');

            modal.style.display = 'flex';
        };

        // Close rejection details modal
        window.closeRejectionModal = function() {
            document.getElementById('rejectionDetailsModal').style.display = 'none';
        };

        // Get detailed rejection information
        function getRejectionDetails(reason, count) {
            const detailsMap = {
                '余额不足': {
                    responseCode: '51',
                    bankResponse: {
                        responseCode: '51',
                        responseMessage: 'Insufficient funds',
                        declineReason: 'INSUFFICIENT_FUNDS',
                        bankCode: '51',
                        bankMessage: '余额不足，请检查账户余额',
                        timestamp: new Date().toISOString(),
                        retryable: true
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '余额不足'
                        },
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '余额不足'
                        }
                    ]
                },
                '卡号无效': {
                    responseCode: '14',
                    bankResponse: {
                        responseCode: '14',
                        responseMessage: 'Invalid card number',
                        declineReason: 'INVALID_CARD',
                        bankCode: '14',
                        bankMessage: '卡号无效或格式错误',
                        timestamp: new Date().toISOString(),
                        retryable: false
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '卡号无效'
                        }
                    ]
                },
                '交易超时': {
                    responseCode: 'TIMEOUT',
                    bankResponse: {
                        responseCode: 'TIMEOUT',
                        responseMessage: 'Transaction timeout',
                        declineReason: 'TIMEOUT',
                        bankCode: null,
                        bankMessage: '银行响应超时，请稍后重试',
                        timestamp: new Date().toISOString(),
                        retryable: true
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '交易超时'
                        }
                    ]
                },
                '风险控制拒绝': {
                    responseCode: '05',
                    bankResponse: {
                        responseCode: '05',
                        responseMessage: 'Do not honor',
                        declineReason: 'RISK_CONTROL',
                        bankCode: '05',
                        bankMessage: '风险控制拒绝，交易被风控系统拦截',
                        timestamp: new Date().toISOString(),
                        retryable: false
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '风险控制拒绝'
                        }
                    ]
                },
                '无效币种配置': {
                    responseCode: 'INVALID_CURRENCY',
                    bankResponse: {
                        responseCode: 'INVALID_CURRENCY',
                        responseMessage: 'Invalid currency configuration',
                        declineReason: 'CONFIG_ERROR',
                        bankCode: null,
                        bankMessage: '币种配置无效：渠道配置中启用了该币种，但实际不支持',
                        timestamp: new Date().toISOString(),
                        retryable: false,
                        configurationError: true,
                        configuredCurrency: 'EUR',
                        supportedCurrencies: ['USD', 'GBP']
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '€' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '无效币种配置'
                        }
                    ]
                },
                '渠道不支持该币种': {
                    responseCode: 'CURRENCY_NOT_SUPPORTED',
                    bankResponse: {
                        responseCode: 'CURRENCY_NOT_SUPPORTED',
                        responseMessage: 'Currency not supported by channel',
                        declineReason: 'CONFIG_ERROR',
                        bankCode: null,
                        bankMessage: '渠道不支持该币种：配置中启用了该币种，但渠道实际不支持',
                        timestamp: new Date().toISOString(),
                        retryable: false,
                        configurationError: true,
                        attemptedCurrency: 'JPY',
                        channelSupportedCurrencies: ['USD', 'EUR', 'GBP']
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '¥' + (Math.random() * 50000 + 5000).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '渠道不支持该币种'
                        }
                    ]
                },
                '渠道维护': {
                    responseCode: 'MAINTENANCE',
                    bankResponse: {
                        responseCode: 'MAINTENANCE',
                        responseMessage: 'Channel under maintenance',
                        declineReason: 'SYSTEM_ERROR',
                        bankCode: null,
                        bankMessage: '渠道正在维护中，请稍后重试',
                        timestamp: new Date().toISOString(),
                        retryable: true,
                        maintenanceWindow: '2024-01-20 02:00 - 04:00 UTC'
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '渠道维护'
                        }
                    ]
                },
                '平台超时': {
                    responseCode: 'PLATFORM_TIMEOUT',
                    bankResponse: {
                        responseCode: 'PLATFORM_TIMEOUT',
                        responseMessage: 'Platform request timeout',
                        declineReason: 'PLATFORM_ERROR',
                        bankCode: null,
                        bankMessage: '平台响应超时，请稍后重试',
                        timestamp: new Date().toISOString(),
                        retryable: true,
                        platform: 'ShopYY',
                        timeoutDuration: '30s'
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '平台超时'
                        }
                    ]
                },
                '平台币种不支持': {
                    responseCode: 'PLATFORM_CURRENCY_NOT_SUPPORTED',
                    bankResponse: {
                        responseCode: 'PLATFORM_CURRENCY_NOT_SUPPORTED',
                        responseMessage: 'Platform does not support this currency',
                        declineReason: 'PLATFORM_ERROR',
                        bankCode: null,
                        bankMessage: '平台不支持该币种：配置中启用了该币种，但平台实际不支持',
                        timestamp: new Date().toISOString(),
                        retryable: false,
                        platform: 'Shopline',
                        attemptedCurrency: 'CNY',
                        platformSupportedCurrencies: ['USD', 'EUR', 'GBP']
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '¥' + (Math.random() * 3000 + 300).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '平台币种不支持'
                        }
                    ]
                },
                '平台加密错误': {
                    responseCode: 'PLATFORM_ENCRYPTION_ERROR',
                    bankResponse: {
                        responseCode: 'PLATFORM_ENCRYPTION_ERROR',
                        responseMessage: 'Platform encryption/decryption error',
                        declineReason: 'PLATFORM_ERROR',
                        bankCode: null,
                        bankMessage: '平台加密错误：数据加密或解密失败',
                        timestamp: new Date().toISOString(),
                        retryable: false,
                        platform: 'Shoplazza',
                        encryptionMethod: 'RSA',
                        errorDetails: 'Failed to encrypt payment data'
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '平台加密错误'
                        }
                    ]
                },
                '平台接口异常': {
                    responseCode: 'PLATFORM_API_ERROR',
                    bankResponse: {
                        responseCode: 'PLATFORM_API_ERROR',
                        responseMessage: 'Platform API error',
                        declineReason: 'PLATFORM_ERROR',
                        bankCode: null,
                        bankMessage: '平台接口异常：平台API返回错误',
                        timestamp: new Date().toISOString(),
                        retryable: true,
                        platform: 'ShopYY',
                        apiEndpoint: '/api/v1/payment/process',
                        httpStatus: 500,
                        errorMessage: 'Internal server error'
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '平台接口异常'
                        }
                    ]
                },
                '平台签名验证失败': {
                    responseCode: 'PLATFORM_SIGNATURE_ERROR',
                    bankResponse: {
                        responseCode: 'PLATFORM_SIGNATURE_ERROR',
                        responseMessage: 'Platform signature verification failed',
                        declineReason: 'PLATFORM_ERROR',
                        bankCode: null,
                        bankMessage: '平台签名验证失败：请求签名验证不通过',
                        timestamp: new Date().toISOString(),
                        retryable: false,
                        platform: 'Shopline',
                        signatureMethod: 'HMAC-SHA256',
                        errorDetails: 'Signature mismatch'
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '平台签名验证失败'
                        }
                    ]
                },
                '其他': {
                    responseCode: 'UNKNOWN',
                    bankResponse: {
                        responseCode: 'UNKNOWN',
                        responseMessage: 'Unknown error',
                        declineReason: 'OTHER',
                        bankCode: null,
                        bankMessage: '未知错误',
                        timestamp: new Date().toISOString(),
                        retryable: false
                    },
                    sampleTransactions: [
                        {
                            transactionId: 'TXN-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                            timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString('zh-CN'),
                            amount: '$' + (Math.random() * 500 + 50).toFixed(2),
                            channel: ['YSEPAY', 'RUMBLE', 'EVONET', 'PAYSAAS'][Math.floor(Math.random() * 4)],
                            response: '其他错误'
                        }
                    ]
                }
            };

            return detailsMap[reason] || detailsMap['其他'];
        }

        // Chart Tab JavaScript
        let chartInstances = {
            channelStats: null,
            transactionStatus: null,
            rejectionReasons: null,
            successRate: null
        };

        // Initialize chart filters (same as analysis filters)
        function initChartFilters() {
            // Load merchant options
            const merchantSelect = document.getElementById('chartMerchantSelect');
            if (merchantSelect && merchantSelect.options.length === 1) {
                const merchants = ['STARSAAS', 'NbcPay', 'NexPay'];
                merchants.forEach(merchant => {
                    const option = document.createElement('option');
                    option.value = merchant.toLowerCase();
                    option.textContent = merchant;
                    merchantSelect.appendChild(option);
                });
                
                merchantSelect.addEventListener('change', function() {
                    updateChartSubMerchantOptions();
                    loadChartData();
                });
            }

            updateChartSubMerchantOptions();
        }

        // Update sub-merchant options for charts
        function updateChartSubMerchantOptions() {
            const merchantSelect = document.getElementById('chartMerchantSelect');
            const subMerchantSelect = document.getElementById('chartSubMerchantSelect');
            const selectedMerchant = merchantSelect ? merchantSelect.value : '';

            if (subMerchantSelect) {
                while (subMerchantSelect.options.length > 1) {
                    subMerchantSelect.remove(1);
                }

                const subMerchants = {
                    'starsaas': ['Sub-Account-001', 'Sub-Account-002', 'Sub-Account-003'],
                    'nbcpay': ['NBC-Sub-001', 'NBC-Sub-002'],
                    'nexpay': ['Nex-Sub-001', 'Nex-Sub-002', 'Nex-Sub-003', 'Nex-Sub-004']
                };

                if (selectedMerchant && subMerchants[selectedMerchant]) {
                    subMerchants[selectedMerchant].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subMerchantSelect.appendChild(option);
                    });
                } else if (!selectedMerchant) {
                    Object.values(subMerchants).flat().forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subMerchantSelect.appendChild(option);
                    });
                }
            }
        }

        // Reset chart filters
        window.resetChartFilters = function() {
            document.getElementById('chartTimePeriodSelect').value = 'last-month';
            document.getElementById('chartMerchantSelect').value = '';
            document.getElementById('chartSubMerchantSelect').value = '';
            document.getElementById('chartChannelSelect').value = '';
            document.getElementById('chartPlatformSelect').value = '';
            updateChartSubMerchantOptions();
            loadChartData();
        };

        // Load chart data and render charts
        window.loadChartData = function() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }

            const timePeriod = document.getElementById('chartTimePeriodSelect')?.value || 'last-month';
            const merchant = document.getElementById('chartMerchantSelect')?.value || '';
            const subMerchant = document.getElementById('chartSubMerchantSelect')?.value || '';
            const channel = document.getElementById('chartChannelSelect')?.value || '';
            const platform = document.getElementById('chartPlatformSelect')?.value || '';
            
            // Get the same data structure as analysis tab
            if (typeof window.getMockAnalysisData !== 'function') {
                console.error('getMockAnalysisData function is not available');
                return;
            }
            
            const data = window.getMockAnalysisData(timePeriod, { merchant, subMerchant, channel, platform });
            
            if (!data) {
                console.error('Failed to get analysis data');
                return;
            }
            
            // Render all charts with a small delay to ensure canvas is ready
            setTimeout(() => {
                renderChannelStatsChart(data);
                renderTransactionStatusChart(data);
                renderRejectionReasonsChart(data);
                renderSuccessRateChart(data);
            }, 50);
        };

        // Render Channel Statistics Chart (Bar Chart with Futuristic Colors)
        function renderChannelStatsChart(data) {
            const ctx = document.getElementById('channelStatsChart');
            if (!ctx) {
                console.error('channelStatsChart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }

            // Destroy existing chart if it exists
            if (chartInstances.channelStats) {
                chartInstances.channelStats.destroy();
            }

            const channels = data.byChannel.map(c => c.channel);
            const totals = data.byChannel.map(c => c.total);
            const successes = data.byChannel.map(c => c.success);
            const failures = data.byChannel.map(c => c.failed);
            const rejections = data.byChannel.map(c => c.rejected);

            // Get canvas 2D context for gradient creation
            const canvasCtx = ctx.getContext('2d');
            if (!canvasCtx) {
                console.error('Could not get 2D context from canvas');
                return;
            }

            // Create gradient functions for futuristic colors
            const createGradient = (color1, color2, x0 = 0, y0 = 0, x1 = 0, y1 = 400) => {
                const gradient = canvasCtx.createLinearGradient(x0, y0, x1, y1);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            };

            chartInstances.channelStats = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: channels,
                    datasets: [
                        {
                            label: '成功',
                            data: successes,
                            backgroundColor: createGradient('#00D4FF', '#0099CC', 0, 0, 0, 300),
                            borderColor: '#00B8E6',
                            borderWidth: 0,
                            borderRadius: 6
                        },
                        {
                            label: '失败',
                            data: failures,
                            backgroundColor: createGradient('#FF6B9D', '#FF4081', 0, 0, 0, 300),
                            borderColor: '#FF6B9D',
                            borderWidth: 0,
                            borderRadius: 6
                        },
                        {
                            label: '拒绝',
                            data: rejections,
                            backgroundColor: createGradient('#C77DFF', '#9D4EDD', 0, 0, 0, 300),
                            borderColor: '#B65FE6',
                            borderWidth: 0,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 12,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 212, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                stepSize: 100,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render Transaction Status Chart (Modern Horizontal Stacked Bar Chart)
        function renderTransactionStatusChart(data) {
            const ctx = document.getElementById('transactionStatusChart');
            if (!ctx) {
                console.error('transactionStatusChart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }

            if (chartInstances.transactionStatus) {
                chartInstances.transactionStatus.destroy();
            }

            const total = data.approved + data.failed + data.rejected;
            
            // Get canvas 2D context for gradient creation
            const canvasCtx = ctx.getContext('2d');
            if (!canvasCtx) {
                console.error('Could not get 2D context from canvas');
                return;
            }
            
            // Create gradient functions for futuristic colors
            const createGradient = (color1, color2) => {
                const gradient = canvasCtx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            };

            chartInstances.transactionStatus = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['交易状态分布'],
                    datasets: [
                        {
                            label: '成功',
                            data: [data.approved],
                            backgroundColor: createGradient('#00D4FF', '#0099CC'),
                            borderColor: '#00B8E6',
                            borderWidth: 0,
                            borderRadius: 4
                        },
                        {
                            label: '失败',
                            data: [data.failed],
                            backgroundColor: createGradient('#FF6B9D', '#FF4081'),
                            borderColor: '#FF6B9D',
                            borderWidth: 0,
                            borderRadius: 4
                        },
                        {
                            label: '拒绝',
                            data: [data.rejected],
                            backgroundColor: createGradient('#C77DFF', '#9D4EDD'),
                            borderColor: '#B65FE6',
                            borderWidth: 0,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.x || 0;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 212, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Render Rejection Reasons Chart (Horizontal Bar Chart with Futuristic Colors)
        function renderRejectionReasonsChart(data) {
            const ctx = document.getElementById('rejectionReasonsChart');
            if (!ctx) {
                console.error('rejectionReasonsChart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }

            if (chartInstances.rejectionReasons) {
                chartInstances.rejectionReasons.destroy();
            }

            // Get top 10 rejection reasons
            const topReasons = data.rejectionReasons.slice(0, 10);
            const reasons = topReasons.map(r => r.reason);
            const counts = topReasons.map(r => r.count);

            // Get canvas 2D context for gradient creation
            const canvasCtx = ctx.getContext('2d');
            if (!canvasCtx) {
                console.error('Could not get 2D context from canvas');
                return;
            }

            // Create gradient for each bar with futuristic colors
            const createGradient = (color1, color2, x0 = 0, y0 = 0, x1 = 400, y1 = 0) => {
                const gradient = canvasCtx.createLinearGradient(x0, y0, x1, y1);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            };

            // Futuristic color palette for bars
            const futuristicColors = [
                ['#00D4FF', '#0099CC'], // Cyan
                ['#C77DFF', '#9D4EDD'], // Purple
                ['#FF6B9D', '#FF4081'], // Pink
                ['#00E5FF', '#00B8CC'], // Light Cyan
                ['#B388FF', '#8E5FE6'], // Light Purple
                ['#FF8A80', '#FF5252'], // Coral
                ['#64FFDA', '#00BFA5'], // Teal
                ['#FFD740', '#FFC400'], // Amber
                ['#7C4DFF', '#651FFF'], // Deep Purple
                ['#FF4081', '#E91E63']  // Deep Pink
            ];

            chartInstances.rejectionReasons = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: reasons,
                    datasets: [{
                        label: '拒绝数量',
                        data: counts,
                        backgroundColor: reasons.map((_, i) => {
                            const colors = futuristicColors[i % futuristicColors.length];
                            return createGradient(colors[0], colors[1]);
                        }),
                        borderColor: reasons.map((_, i) => {
                            const colors = futuristicColors[i % futuristicColors.length];
                            return colors[0];
                        }),
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#00D4FF',
                            bodyColor: '#fff',
                            borderColor: '#00D4FF',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `拒绝数量: ${context.parsed.x.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 212, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render Success Rate Chart (Bar Chart with Futuristic Gradient Colors)
        function renderSuccessRateChart(data) {
            const ctx = document.getElementById('successRateChart');
            if (!ctx) {
                console.error('successRateChart canvas not found');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }

            if (chartInstances.successRate) {
                chartInstances.successRate.destroy();
            }

            const channels = data.byChannel.map(c => c.channel);
            const successRates = data.byChannel.map(c => c.successRate);

            // Get canvas 2D context for gradient creation
            const canvasCtx = ctx.getContext('2d');
            if (!canvasCtx) {
                console.error('Could not get 2D context from canvas');
                return;
            }

            // Create gradient function for futuristic colors
            const createGradient = (color1, color2, x0 = 0, y0 = 0, x1 = 0, y1 = 400) => {
                const gradient = canvasCtx.createLinearGradient(x0, y0, x1, y1);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            };

            // Futuristic color scheme based on success rate
            const getFuturisticColors = (rate) => {
                if (rate >= 90) {
                    return { bg: createGradient('#00D4FF', '#0099CC'), border: '#00B8E6' }; // Cyan gradient for high success
                } else if (rate >= 80) {
                    return { bg: createGradient('#C77DFF', '#9D4EDD'), border: '#B65FE6' }; // Purple gradient for medium
                } else {
                    return { bg: createGradient('#FF6B9D', '#FF4081'), border: '#FF6B9D' }; // Pink gradient for low
                }
            };

            const colors = successRates.map(rate => getFuturisticColors(rate));

            chartInstances.successRate = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: channels,
                    datasets: [{
                        label: '成功率 (%)',
                        data: successRates,
                        backgroundColor: colors.map(c => c.bg),
                        borderColor: colors.map(c => c.border),
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#00D4FF',
                            bodyColor: '#fff',
                            borderColor: '#00D4FF',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const rate = context.parsed.y;
                                    let status = '';
                                    if (rate >= 90) status = '优秀';
                                    else if (rate >= 80) status = '良好';
                                    else status = '需改进';
                                    return `成功率: ${rate.toFixed(1)}% (${status})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 212, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // Summary Table and Form Toggle Functions
        // ============================================

        // State management for summary table
        let summaryData = [];
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 10;
        let selectedRowId = null;

        // Load summary data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSummaryData();
            populateFilterDropdowns();
        });

        // Load summary data from API
        async function loadSummaryData() {
            try {
                const response = await fetch('/api/channel-binding/list', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    summaryData = data.bindings || [];
                    filteredData = [...summaryData];
                    renderSummaryTable();
                } else {
                    // Fallback: use mock data for development
                    console.warn('API call failed, using mock data');
                    summaryData = getMockSummaryData();
                    filteredData = [...summaryData];
                    renderSummaryTable();
                }
            } catch (error) {
                console.error('Failed to load summary data:', error);
                // Use mock data as fallback
                summaryData = getMockSummaryData();
                filteredData = [...summaryData];
                renderSummaryTable();
            }
        }

        // Mock data for development
        function getMockSummaryData() {
            return [
                {
                    id: '1',
                    merchantName: 'test0121',
                    subAccount: 'test0112',
                    channel: 'ONERWAY',
                    paymentType: 'Credit Card',
                    channelName: 'ONERWAY11040401001',
                    terminalCode: '1',
                    terminalPassword: '11',
                    terminalToken: '1',
                    paypalAccount: '',
                    status: '绑定',
                    creator: 'staradmin',
                    createdAt: '2026-01-21 07:41:43'
                },
                {
                    id: '2',
                    merchantName: 'Demo Merchant 1',
                    subAccount: 'Can',
                    channel: 'METROSPAY',
                    paymentType: 'Credit Card',
                    channelName: 'METROSPAY1701001021',
                    terminalCode: '100',
                    terminalPassword: '1722207571190743041',
                    terminalToken: '000000',
                    paypalAccount: '',
                    status: '绑定',
                    creator: 'staradmin',
                    createdAt: '2026-01-21 08:15:22'
                },
                {
                    id: '3',
                    merchantName: '空云PaymentLink VCC',
                    subAccount: 'AIRWALLEX',
                    channel: 'AIRWALLEX',
                    paymentType: 'Credit Card',
                    channelName: 'AIRWALLEX001',
                    terminalCode: '67eb62c1157493d2784ab2d2',
                    terminalPassword: 'sk_sandbox_373705b21606468aaaf4d179e2e1a472',
                    terminalToken: 'MIIEKgIBADANBgkqhkiG9w0BAQEFAASCBBQwggQQAgEAAoHiAl....',
                    paypalAccount: 'kid_c4f8ba8f7f2f405f876f84c87d673849',
                    status: '绑定',
                    creator: 'allen liao',
                    createdAt: '2026-01-21 09:30:15'
                }
            ];
        }

        // Render summary table
        function renderSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            if (!tbody) return;

            // Calculate pagination
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredData.slice(startIndex, endIndex);

            // Clear existing rows
            tbody.innerHTML = '';

            // Render rows
            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.dataset.id = item.id;
                row.onclick = () => selectRow(item.id);
                
                row.innerHTML = `
                    <td>
                        <input type="radio" name="table-select" value="${item.id}" 
                               ${selectedRowId === item.id ? 'checked' : ''}
                               onclick="event.stopPropagation(); selectRow('${item.id}')">
                    </td>
                    <td>${escapeHtml(item.merchantName || '')}</td>
                    <td>${escapeHtml(item.subAccount || '')}</td>
                    <td>${escapeHtml(item.channel || '')}</td>
                    <td>${escapeHtml(item.paymentType || '')}</td>
                    <td>${escapeHtml(item.channelName || '')}</td>
                    <td>${escapeHtml(item.terminalCode || '')}</td>
                    <td>${maskSensitiveData(item.terminalPassword || '')}</td>
                    <td>${maskSensitiveData(item.terminalToken || '')}</td>
                    <td>${escapeHtml(item.paypalAccount || '')}</td>
                    <td><span class="status-badge status-${item.status === '绑定' ? 'bound' : 'unbound'}">${escapeHtml(item.status || '')}</span></td>
                    <td>${escapeHtml(item.creator || '')}</td>
                    <td>${escapeHtml(item.createdAt || '')}</td>
                `;
                tbody.appendChild(row);
            });

            // Update pagination info
            updatePaginationInfo();
        }

        // Mask sensitive data (show only first and last few characters)
        function maskSensitiveData(value) {
            if (!value || value.length <= 8) return '***';
            return value.substring(0, 4) + '***' + value.substring(value.length - 4);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Select row
        function selectRow(id) {
            selectedRowId = id;
            renderSummaryTable();
            updateActionButtons();
        }

        // Update action buttons based on selection
        function updateActionButtons() {
            const modifyBtn = document.querySelector('.modify-btn');
            const unbindBtn = document.querySelector('.unbind-btn');
            const copyBtn = document.querySelector('.copy-btn');
            
            const hasSelection = selectedRowId !== null;
            
            if (modifyBtn) modifyBtn.disabled = !hasSelection;
            if (unbindBtn) unbindBtn.disabled = !hasSelection;
            if (copyBtn) copyBtn.disabled = !hasSelection;
        }

        // Show add new form
        function showAddNewForm() {
            document.getElementById('summarySection').style.display = 'none';
            document.getElementById('configFormCard').style.display = 'block';
            selectedRowId = null;
            // Reset form
            if (document.getElementById('channelBindingForm')) {
                document.getElementById('channelBindingForm').reset();
            }
        }

        // Hide add new form (show summary)
        function hideAddNewForm() {
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('configFormCard').style.display = 'none';
            // Reload data in case new binding was added
            loadSummaryData();
        }

        // Apply filters
        function applyFilters() {
            const merchantName = document.getElementById('filter-merchant-name').value.toLowerCase();
            const subAccount = document.getElementById('filter-sub-account').value;
            const channel = document.getElementById('filter-channel').value;

            filteredData = summaryData.filter(item => {
                const matchesMerchant = !merchantName || (item.merchantName || '').toLowerCase().includes(merchantName);
                const matchesSubAccount = !subAccount || item.subAccount === subAccount;
                const matchesChannel = !channel || item.channel === channel;
                
                return matchesMerchant && matchesSubAccount && matchesChannel;
            });

            currentPage = 1;
            renderSummaryTable();
        }

        // Populate filter dropdowns
        async function populateFilterDropdowns() {
            // Populate sub-account dropdown
            const subAccountSelect = document.getElementById('filter-sub-account');
            const subAccounts = [...new Set(summaryData.map(item => item.subAccount).filter(Boolean))];
            subAccounts.forEach(subAccount => {
                const option = document.createElement('option');
                option.value = subAccount;
                option.textContent = subAccount;
                subAccountSelect.appendChild(option);
            });

            // Populate channel dropdown
            const channelSelect = document.getElementById('filter-channel');
            const channels = [...new Set(summaryData.map(item => item.channel).filter(Boolean))];
            channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelSelect.appendChild(option);
            });
        }

        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderSummaryTable();
            }
        }

        // Change page size
        function changePageSize() {
            const select = document.getElementById('pageSizeSelect');
            pageSize = parseInt(select.value);
            currentPage = 1;
            renderSummaryTable();
        }

        // Update pagination info
        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredData.length);
            const rangeEl = document.getElementById('paginationRange');
            if (rangeEl) {
                rangeEl.textContent = `${startIndex}~${endIndex}`;
            }

            const totalPages = Math.ceil(filteredData.length / pageSize);
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }

        // Modify selected
        function modifySelected() {
            if (!selectedRowId) return;
            const item = summaryData.find(d => d.id === selectedRowId);
            if (!item) return;
            
            // Show form and populate with selected item data
            showAddNewForm();
            // TODO: Populate form fields with item data
            console.log('Modify:', item);
        }

        // Unbind selected
        async function unbindSelected() {
            if (!selectedRowId) return;
            
            if (!confirm('确定要解绑选中的渠道吗？')) return;

            try {
                const response = await fetch(`/api/channel-binding/unbind/${selectedRowId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    alert('解绑成功');
                    loadSummaryData();
                } else {
                    alert('解绑失败，请重试');
                }
            } catch (error) {
                console.error('Unbind error:', error);
                alert('解绑失败，请重试');
            }
        }

        // Copy selected
        function copySelected() {
            if (!selectedRowId) return;
            const item = summaryData.find(d => d.id === selectedRowId);
            if (!item) return;
            
            // Show form and populate with selected item data (for editing)
            showAddNewForm();
            // TODO: Populate form fields with item data (as template for new binding)
            console.log('Copy:', item);
        }

    </script>
</body>
</html>
